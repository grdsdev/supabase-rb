{
  "project": "Supabase Ruby SDK",
  "description": "Build a complete, idiomatic Ruby SDK for Supabase based on the official service specifications. The SDK consists of 6 independent gems that can be used standalone or composed together via a top-level orchestrator gem. Each module communicates with its respective Supabase service (Auth/GoTrue, PostgREST, Realtime, Storage, Functions) and follows Ruby conventions (snake_case, blocks, enumerables, etc.). The SDK is framework-agnostic and includes a full test suite.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Project Scaffolding and Shared Infrastructure",
      "description": "As a developer, I want the multi-gem project structure set up with shared conventions so that each module can be developed and released independently.",
      "acceptanceCriteria": [
        "Create gemspec for each of the 6 gems with proper metadata, versioning (0.1.0), and Ruby \u003e= 3.1 requirement",
        "Set up a monorepo structure with gems/supabase, gems/supabase-auth, gems/supabase-postgrest, gems/supabase-realtime, gems/supabase-storage, gems/supabase-functions",
        "Each gem has its own lib/, spec/, Gemfile, and .gemspec",
        "Root Gemfile and Rakefile that can run all gem specs",
        "Shared CI-friendly test runner (e.g., rake spec at root runs all gems)",
        "Each gem depends only on faraday (HTTP) or faye-websocket/websocket-client-simple (WebSocket) as needed -- no cross-gem runtime dependencies",
        "Add .rubocop.yml with standard Ruby style configuration",
        "Add a shared VERSION constant pattern per gem"
      ],
      "priority": 1,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-002",
      "title": "Functions Client - Core",
      "description": "As a developer, I want to invoke Supabase Edge Functions from Ruby so that I can call serverless functions with automatic body serialization and response parsing.",
      "acceptanceCriteria": [
        "Supabase::Functions::Client.new(url:, headers: {}, region: :any, fetch: nil) constructor",
        "client.set_auth(token) sets Authorization: Bearer {token} for subsequent calls",
        "client.invoke(function_name, body: nil, headers: {}, method: :post, region: nil, timeout: nil) invokes a function",
        "Returns { data:, error: } result hash (never raises by default)",
        "Auto-detects body content type: String -\u003e text/plain, Hash/Array -\u003e application/json (JSON-serialized), IO/StringIO -\u003e application/octet-stream",
        "Parses response by Content-Type: JSON parsed, octet-stream as binary string, text as string, text/event-stream returns raw response",
        "Error hierarchy: FunctionsError (base), FunctionsFetchError (network), FunctionsRelayError (x-relay-error header), FunctionsHttpError (non-2xx)",
        "Region routing: sets x-region header and forceFunctionRegion query param when region is not :any",
        "Header precedence: auto-detected \u003c client-level \u003c invoke-level",
        "Timeout support via per-request deadline",
        "HTTP methods: POST (default), GET, PUT, PATCH, DELETE"
      ],
      "priority": 2,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-003",
      "title": "Functions Client - Tests",
      "description": "As a developer, I want full test coverage for the Functions client so that I can verify all invocation, serialization, error handling, and region routing behaviors.",
      "acceptanceCriteria": [
        "Unit tests for body auto-detection (String, Hash, IO, nil)",
        "Unit tests for response parsing (JSON, text, binary, event-stream)",
        "Unit tests for error classification (FunctionsFetchError, FunctionsRelayError, FunctionsHttpError)",
        "Unit tests for header precedence (invoke \u003e client \u003e auto-detected)",
        "Unit tests for region routing (header + query param set/not set)",
        "Unit tests for timeout behavior",
        "Unit tests for set_auth persistence",
        "Unit tests for all HTTP methods",
        "Integration-style tests with stubbed HTTP using WebMock or similar",
        "Covers test scenarios AU-01 through AU-05, BH-01 through BH-08, RP-01 through RP-08, EH-01 through EH-08, RR-01 through RR-05, TC-01 through TC-05, HP-01 through HP-03, HM-01 through HM-05 from the spec"
      ],
      "priority": 3,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-004",
      "title": "PostgREST Client - Core Builder Infrastructure",
      "description": "As a developer, I want a PostgREST client with a chainable query builder so that I can construct type-safe database queries using an ORM-like interface.",
      "acceptanceCriteria": [
        "Supabase::PostgREST::Client.new(url:, headers: {}, schema: nil, fetch: nil, timeout: nil) constructor",
        "client.from(relation) returns a QueryBuilder scoped to the table/view",
        "client.schema(name) returns a new client targeting a different schema",
        "client.rpc(fn, args: {}, head: false, get: false, count: nil) calls remote procedures",
        "Builder base class: carries method, URL, headers, body, schema; implements lazy execution via a then-like pattern or explicit .execute / .call",
        "All responses return { data:, error:, count:, status:, status_text: } result hash",
        "PostgrestError with message, details, hint, code fields",
        ".throw_on_error mode raises PostgrestError instead of returning it",
        "Schema headers: Accept-Profile for GET/HEAD, Content-Profile for POST/PATCH/DELETE",
        "Immutability: from() clones URL/headers so multiple queries from the same builder are independent"
      ],
      "priority": 4,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-005",
      "title": "PostgREST Client - CRUD Operations",
      "description": "As a developer, I want to perform SELECT, INSERT, UPDATE, UPSERT, and DELETE operations so that I can do full CRUD against my Supabase database.",
      "acceptanceCriteria": [
        ".select(columns = \"*\", head: false, count: nil) - GET request with ?select= param; strips whitespace; supports count: :exact/:planned/:estimated",
        ".insert(values, count: nil, default_to_null: true) - POST with JSON body; bulk insert sets columns param from union of keys; Prefer: missing=default when default_to_null: false",
        ".update(values, count: nil) - PATCH with JSON body",
        ".upsert(values, on_conflict: nil, ignore_duplicates: false, count: nil, default_to_null: true) - POST with Prefer: resolution=merge-duplicates or resolution=ignore-duplicates; sets on_conflict URL param",
        ".delete(count: nil) - DELETE method",
        "Mutation results support .select(columns) which adds Prefer: return=representation"
      ],
      "priority": 5,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-006",
      "title": "PostgREST Client - Filter Builder",
      "description": "As a developer, I want to chain filter methods on queries so that I can precisely control which rows are returned or affected.",
      "acceptanceCriteria": [
        "Comparison filters: .eq, .neq, .gt, .gte, .lt, .lte - append column=op.value",
        "Null/Boolean: .is(column, value) for null/true/false; .is_distinct(column, value)",
        "Pattern: .like, .ilike, .like_all_of, .like_any_of, .ilike_all_of, .ilike_any_of",
        "Regex: .match(column, pattern) (PostgREST match op), .imatch(column, pattern)",
        "Collection: .in(column, values) with reserved char quoting; .contains (cs), .contained_by (cd), .overlaps (ov)",
        "Range: .range_gt (sr), .range_gte (nxl), .range_lt (sl), .range_lte (nxr), .range_adjacent (adj)",
        "Text search: .text_search(column, query, type: nil, config: nil) supporting fts/plfts/phfts/wfts",
        "Compound: .match_filter(query_hash) (multiple eq from hash), .not(column, op, value), .or(filters, referenced_table: nil), .filter(column, op, value)",
        "All filter methods return self for chaining"
      ],
      "priority": 6,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-007",
      "title": "PostgREST Client - Transform Builder",
      "description": "As a developer, I want to order, paginate, and shape query results so that I can control the response format.",
      "acceptanceCriteria": [
        ".order(column, ascending: true, nulls_first: nil, referenced_table: nil) - supports multiple calls (appends)",
        ".limit(count, referenced_table: nil)",
        ".range(from, to, referenced_table: nil) - 0-based inclusive; sets offset and limit",
        ".single - sets Accept: application/vnd.pgrst.object+json; errors if != 1 row",
        ".maybe_single - returns single object or nil; synthesizes PGRST116 error on \u003e1 row for GET; unwraps array",
        ".csv - sets Accept: text/csv",
        ".geojson - sets Accept: application/geo+json",
        ".explain(analyze: false, verbose: false, settings: false, buffers: false, wal: false, format: :text)",
        ".rollback - appends Prefer: tx=rollback",
        ".max_affected(value) - appends Prefer: handling=strict,max-affected={value}"
      ],
      "priority": 7,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-008",
      "title": "PostgREST Client - Tests",
      "description": "As a developer, I want comprehensive tests for the PostgREST client covering all CRUD, filter, transform, RPC, schema, and error scenarios.",
      "acceptanceCriteria": [
        "Tests for client initialization (CI-01 through CI-06)",
        "Tests for SELECT operations (SE-01 through SE-07)",
        "Tests for INSERT operations (IN-01 through IN-05)",
        "Tests for UPDATE operations (UP-01 through UP-02)",
        "Tests for UPSERT operations (US-01 through US-03)",
        "Tests for DELETE operations (DE-01 through DE-03)",
        "Tests for all filters (FI-01 through FI-25)",
        "Tests for all transforms (TR-01 through TR-17)",
        "Tests for RPC (RP-01 through RP-07)",
        "Tests for error handling (EH-01 through EH-08)",
        "Tests for schema switching (SC-01 through SC-04)",
        "Tests for builder immutability (BI-01 through BI-03)",
        "URL construction validation (query params generated correctly)"
      ],
      "priority": 8,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-009",
      "title": "Storage Client - Core and Bucket Management",
      "description": "As a developer, I want to manage Supabase Storage buckets so that I can create, list, update, empty, and delete file containers.",
      "acceptanceCriteria": [
        "Supabase::Storage::Client.new(url:, headers: {}, fetch: nil) constructor",
        "client.list_buckets(limit: nil, offset: nil, sort_by: nil, search: nil) returns array of Bucket objects",
        "client.get_bucket(id) returns a Bucket",
        "client.create_bucket(id, public: false, file_size_limit: nil, allowed_mime_types: nil) returns { name: }",
        "client.update_bucket(id, public:, file_size_limit: nil, allowed_mime_types: nil) returns { message: }",
        "client.empty_bucket(id) returns { message: }",
        "client.delete_bucket(id) returns { message: }",
        "client.from(bucket_id) returns a StorageFileApi scoped to the bucket",
        "All methods return { data:, error: } result pattern",
        "Error hierarchy: StorageError (base), StorageApiError (HTTP), StorageUnknownError (network)"
      ],
      "priority": 9,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-010",
      "title": "Storage Client - File Operations",
      "description": "As a developer, I want to upload, download, move, copy, and delete files so that I can manage objects in Supabase Storage.",
      "acceptanceCriteria": [
        ".upload(path, body, cache_control: \"3600\", content_type: nil, upsert: false, metadata: nil) - POST with auto-detection (IO/StringIO as raw body, String as raw); returns { id:, path:, full_path: }",
        ".update(path, body, **opts) - PUT method for replacing files",
        ".download(path, transform: nil) - GET returns binary data; uses /render/image/authenticated/ path when transform provided",
        ".move(from_path, to_path, destination_bucket: nil) - POST /object/move",
        ".copy(from_path, to_path, destination_bucket: nil) - POST /object/copy",
        ".remove(paths) - DELETE /object/{bucket} with prefixes body",
        ".info(path) - GET returns file metadata with snake_case to camelCase conversion",
        ".exists?(path) - HEAD returns boolean",
        "Path normalization: strips leading/trailing slashes, collapses consecutive slashes"
      ],
      "priority": 10,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-011",
      "title": "Storage Client - URLs and Listing",
      "description": "As a developer, I want to generate signed URLs, public URLs, and list files so that I can share files and browse bucket contents.",
      "acceptanceCriteria": [
        ".create_signed_url(path, expires_in, download: nil, transform: nil) - POST returns full signed URL with download param",
        ".create_signed_urls(paths, expires_in, download: nil) - batch signed URL generation",
        ".create_signed_upload_url(path, upsert: false) - returns { signed_url:, token:, path: }",
        ".upload_to_signed_url(path, token, body, **opts) - PUT with token query param",
        ".get_public_url(path, download: nil, transform: nil) - synchronous URL construction (no HTTP), uses /render/image/public/ for transforms",
        ".list(path = nil, limit: 100, offset: 0, sort_by: { column: \"name\", order: \"asc\" }, search: nil) - POST returns file objects",
        "Image transform query params: width, height, resize, quality, format",
        "All URLs are properly URI-encoded"
      ],
      "priority": 11,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-012",
      "title": "Storage Client - Tests",
      "description": "As a developer, I want full test coverage for Storage client covering buckets, uploads, downloads, URLs, listings, and error handling.",
      "acceptanceCriteria": [
        "Bucket management tests (BM-01 through BM-09)",
        "Upload tests (UL-01 through UL-11)",
        "Download tests (DL-01 through DL-06)",
        "Signed URL tests (SU-01 through SU-07)",
        "Public URL tests (PU-01 through PU-04)",
        "File operation tests (FO-01 through FO-07)",
        "File listing tests (FL-01 through FL-06)",
        "Error handling tests (EH-01 through EH-04)",
        "Path normalization tests",
        "Image transform query string generation tests"
      ],
      "priority": 12,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-013",
      "title": "Auth Client - Core Infrastructure",
      "description": "As a developer, I want the Auth client foundation with session management, the result pattern, error hierarchy, and storage abstraction so that all auth methods have a solid base.",
      "acceptanceCriteria": [
        "Supabase::Auth::Client.new(url:, headers: {}, storage_key: \"supabase.auth.token\", auto_refresh_token: true, persist_session: true, detect_session_in_url: true, flow_type: :implicit, storage: nil, fetch: nil, lock: nil, debug: false) constructor",
        "All public methods return { data:, error: } result objects (never raise by default)",
        "Error hierarchy: AuthError (base), AuthApiError, AuthRetryableFetchError, AuthUnknownError, AuthSessionMissingError, AuthInvalidTokenResponseError, AuthInvalidCredentialsError, AuthWeakPasswordError, AuthPKCEGrantCodeExchangeError",
        "Type guards: auth_error?, auth_api_error?, auth_session_missing_error?, auth_retryable_fetch_error?",
        "Error classification: 4xx JSON -\u003e AuthApiError, 4xx non-JSON -\u003e AuthUnknownError, 502/503/504 -\u003e AuthRetryableFetchError, network failure -\u003e AuthRetryableFetchError (status 0), weak_password code -\u003e AuthWeakPasswordError",
        "StorageAdapter interface: get_item(key), set_item(key, value), remove_item(key) with MemoryStorage built-in adapter",
        "Session model: access_token, refresh_token, expires_in, expires_at, token_type, user; computes expires_at if missing",
        "HTTP layer: sends X-Supabase-Api-Version: 2024-01-01 and X-Client-Info headers on all requests",
        "Lock mechanism: process-level mutex with configurable timeout (default 10s); serializes concurrent session operations",
        "JWT decoding utility (decode without signature verification, base64url)"
      ],
      "priority": 13,
      "passes": true,
      "inProgress": false
    },
    {
      "id": "US-014",
      "title": "Auth Client - Sign Up and Sign In Methods",
      "description": "As a developer, I want to sign up and sign in users with various methods (password, OAuth, OTP, ID token, SSO, anonymous) so that I can authenticate users in my Ruby application.",
      "acceptanceCriteria": [
        "sign_up(email: nil, phone: nil, password:, data: nil, captcha_token: nil, channel: \"sms\") - POST /signup; validates email or phone present; returns { user:, session: }; includes PKCE params when flow_type is :pkce",
        "sign_in_with_password(email: nil, phone: nil, password:, captcha_token: nil) - POST /token?grant_type=password; saves session; emits SIGNED_IN",
        "sign_in_with_oauth(provider:, redirect_to: nil, scopes: nil, query_params: nil, skip_browser_redirect: nil) - builds authorize URL (no HTTP); includes PKCE challenge when applicable; returns { provider:, url: }",
        "sign_in_with_otp(email: nil, phone: nil, should_create_user: true, data: nil, captcha_token: nil, channel: \"sms\") - POST /otp; returns { message_id: }",
        "verify_otp(email: nil, phone: nil, token_hash: nil, token:, type:) - POST /verify; saves session on success",
        "sign_in_with_id_token(provider:, token:, access_token: nil, nonce: nil, captcha_token: nil) - POST /token?grant_type=id_token",
        "sign_in_with_sso(provider_id: nil, domain: nil, redirect_to: nil, captcha_token: nil) - POST /sso; returns { url: }",
        "sign_in_anonymously(data: nil, captcha_token: nil) - POST /signup with empty body; returns user with is_anonymous: true",
        "exchange_code_for_session(auth_code) - POST /token?grant_type=pkce; retrieves/deletes stored code verifier; emits appropriate events"
      ],
      "priority": 14,
      "passes": false
    },
    {
      "id": "US-015",
      "title": "Auth Client - Session Management",
      "description": "As a developer, I want to manage sessions (get, set, refresh, sign out) with automatic token refresh so that users stay authenticated.",
      "acceptanceCriteria": [
        "get_session - loads from storage; refreshes if expired (with EXPIRY_MARGIN_MS = 90s buffer); returns { session: } or { session: nil }",
        "set_session(access_token:, refresh_token:) - decodes JWT, validates structure, refreshes if expired, saves session, emits SIGNED_IN and TOKEN_REFRESHED",
        "refresh_session(current_session: nil) - uses provided or stored refresh token; POST /token?grant_type=refresh_token; returns new session",
        "sign_out(scope: :global) - POST /logout; removes local session; emits SIGNED_OUT; supports scopes :global, :local, :others",
        "Auto-refresh: background thread checks every 30s; refreshes when \u003c= 3 ticks from expiry; exponential backoff retry (200ms base, doubles, max 10 retries); only retries AuthRetryableFetchError",
        "start_auto_refresh / stop_auto_refresh for manual control",
        "Concurrent refresh deduplication: multiple callers share a single HTTP call result",
        "get_user(jwt: nil) - GET /user (always makes HTTP call, never cached)",
        "update_user(email: nil, phone: nil, password: nil, nonce: nil, data: nil) - PUT /user; emits USER_UPDATED",
        "reset_password_for_email(email, redirect_to: nil, captcha_token: nil) - POST /recover",
        "reauthenticate - GET /reauthenticate",
        "resend(type:, email: nil, phone: nil) - POST /resend"
      ],
      "priority": 15,
      "passes": false
    },
    {
      "id": "US-016",
      "title": "Auth Client - Auth State Events",
      "description": "As a developer, I want to subscribe to auth state changes so that I can react to sign-in, sign-out, token refresh, and other auth events.",
      "acceptanceCriteria": [
        "on_auth_state_change { |event, session| ... } - registers a block-based listener; returns Subscription with id and unsubscribe method",
        "Events: INITIAL_SESSION, SIGNED_IN, SIGNED_OUT, TOKEN_REFRESHED, USER_UPDATED, PASSWORD_RECOVERY, MFA_CHALLENGE_VERIFIED",
        "INITIAL_SESSION fires once per subscription (asynchronously) with current session or nil",
        "Events delivered to all listeners in registration order",
        "Listener errors are caught and logged (do not propagate)",
        "unsubscribe stops event delivery to that listener"
      ],
      "priority": 16,
      "passes": false
    },
    {
      "id": "US-017",
      "title": "Auth Client - MFA API",
      "description": "As a developer, I want Multi-Factor Authentication support (TOTP, Phone) so that I can add second-factor verification to my application.",
      "acceptanceCriteria": [
        "mfa.enroll(factor_type:, friendly_name: nil, issuer: nil, phone: nil) - POST /factors; returns factor with QR code (TOTP) or phone (Phone)",
        "mfa.challenge(factor_id:) - POST /factors/{id}/challenge; returns challenge ID",
        "mfa.verify(factor_id:, challenge_id:, code:) - POST /factors/{id}/verify; saves aal2 session; emits MFA_CHALLENGE_VERIFIED",
        "mfa.unenroll(factor_id:) - DELETE /factors/{id}",
        "mfa.challenge_and_verify(factor_id:, code:) - convenience method combining challenge + verify",
        "mfa.list_factors - calls get_user, categorizes factors by type",
        "mfa.get_authenticator_assurance_level(jwt: nil) - returns { current_level:, next_level:, current_authentication_methods: }"
      ],
      "priority": 17,
      "passes": false
    },
    {
      "id": "US-018",
      "title": "Auth Client - Admin API",
      "description": "As a developer, I want admin user management methods (requires service role key) so that I can manage users programmatically.",
      "acceptanceCriteria": [
        "admin.create_user(email: nil, phone: nil, password: nil, user_metadata: nil, app_metadata: nil, email_confirm: nil, phone_confirm: nil, ban_duration: nil) - POST /admin/users",
        "admin.list_users(page: nil, per_page: nil) - GET /admin/users",
        "admin.get_user_by_id(uid) - GET /admin/users/{uid}",
        "admin.update_user_by_id(uid, **attributes) - PUT /admin/users/{uid}",
        "admin.delete_user(id, should_soft_delete: false) - DELETE /admin/users/{id}",
        "admin.invite_user_by_email(email, data: nil, redirect_to: nil) - POST /invite",
        "admin.generate_link(type:, email:, password: nil, new_email: nil, data: nil, redirect_to: nil) - POST /admin/generate_link; returns link properties",
        "admin.sign_out(jwt, scope: :global) - POST /logout with provided JWT"
      ],
      "priority": 18,
      "passes": false
    },
    {
      "id": "US-019",
      "title": "Auth Client - PKCE Flow",
      "description": "As a developer, I want PKCE flow support so that I can use secure OAuth flows in public clients.",
      "acceptanceCriteria": [
        "Code verifier generation: 56 random bytes -\u003e 112-character hex string using SecureRandom",
        "Code challenge generation: SHA-256 hash of verifier, base64url-encoded (no padding), method s256",
        "Code verifier stored under {storage_key}-code-verifier; consumed (deleted) after use",
        "Password recovery flag: appends /PASSWORD_RECOVERY suffix to stored verifier",
        "exchange_code_for_session retrieves verifier, sends to /token?grant_type=pkce, cleans up storage",
        "Sign-up, OTP, OAuth, SSO methods include code_challenge and code_challenge_method when flow_type: :pkce"
      ],
      "priority": 19,
      "passes": false
    },
    {
      "id": "US-020",
      "title": "Auth Client - Tests",
      "description": "As a developer, I want comprehensive tests for the Auth client covering all authentication flows, session management, events, MFA, admin, PKCE, and error handling.",
      "acceptanceCriteria": [
        "Client configuration tests (CF-01 through CF-05)",
        "Sign up tests (SU-01 through SU-07)",
        "Sign in tests (SI-01 through SI-04)",
        "Phone auth tests (PH-01 through PH-03)",
        "OAuth tests (OA-01 through OA-05)",
        "OTP tests (OT-01 through OT-05)",
        "ID token tests (IT-01 through IT-02)",
        "SSO tests (SS-01 through SS-02)",
        "Anonymous tests (AN-01 through AN-03)",
        "Session management tests (SM-01 through SM-09)",
        "PKCE tests (PK-01 through PK-03)",
        "Sign out tests (SO-01 through SO-03)",
        "User management tests (UM-01 through UM-04)",
        "Password recovery tests (PR-01 through PR-02)",
        "Auth state event tests (EV-01 through EV-06)",
        "Admin API tests (AD-01 through AD-13)",
        "HTTP error handling tests (HE-01 through HE-05)",
        "Locking tests (LK-01 through LK-04)",
        "Storage adapter tests (SA-01 through SA-03)",
        "JWT utility tests (JW-01 through JW-03)",
        "Base64URL tests (B6-01 through B6-05)",
        "Resend tests (RS-01 through RS-03)"
      ],
      "priority": 20,
      "passes": false
    },
    {
      "id": "US-021",
      "title": "Realtime Client - Core Connection Management",
      "description": "As a developer, I want a Realtime client that manages a WebSocket connection with automatic reconnection and heartbeat so that I can receive live updates.",
      "acceptanceCriteria": [
        "Supabase::Realtime::Client.new(url, params: {}, timeout: 10_000, heartbeat_interval_ms: 25_000, reconnect_after_ms: nil, logger: nil, access_token: nil) constructor",
        "Validates params[:apikey] is present; raises if missing",
        "Appends /socket/websocket to URL for WebSocket connection",
        "Derives HTTP broadcast endpoint from WebSocket URL (ws-\u003ehttp, strip suffixes, append /api/broadcast)",
        "Client state machine: :closed -\u003e :connecting -\u003e :open -\u003e :closing -\u003e :closed with reconnection",
        "connect establishes WebSocket with apikey and vsn as query params",
        "disconnect closes WebSocket gracefully",
        "Heartbeat: sends {\"topic\":\"phoenix\",\"event\":\"heartbeat\",\"payload\":{},\"ref\":\"{ref}\"} every heartbeat_interval_ms; triggers reconnect on missed heartbeat reply",
        "Reconnection: exponential backoff (1s, 2s, 5s, 10s capped); reconnects all previously joined channels",
        "set_auth(token) updates the access token for all channels",
        "Send buffer: queues messages when disconnected, flushes on reconnect",
        "Message routing: dispatches incoming messages to channels by topic",
        "Ref counter: monotonically increasing string ref for push/reply correlation"
      ],
      "priority": 21,
      "passes": false
    },
    {
      "id": "US-022",
      "title": "Realtime Client - Channel API",
      "description": "As a developer, I want to create channels with broadcast, presence, and postgres_changes listeners so that I can subscribe to real-time events.",
      "acceptanceCriteria": [
        "client.channel(name, config: {}) creates a RealtimeChannel for topic realtime:{name}",
        "Channel state machine: :closed -\u003e :joining -\u003e :joined -\u003e :leaving -\u003e :closed with rejoin support",
        ".on_broadcast(event) { |payload| ... } registers a broadcast listener",
        ".on_presence(event) { |payload| ... } registers a presence listener (event: :sync, :join, :leave)",
        ".on_postgres_changes(event:, schema: \"public\", table: nil, filter: nil) { |payload| ... } registers a CDC listener (event: :insert, :update, :delete, :all)",
        ".subscribe { |status, error| ... } joins the channel; sends phx_join with config payload including all registered bindings",
        ".unsubscribe leaves the channel; sends phx_leave",
        "client.remove_channel(channel) unsubscribes and removes from client",
        "client.remove_all_channels removes all channels",
        "client.get_channels returns all active channels",
        ".send_broadcast(event:, payload:, type: :websocket) sends a broadcast message; supports :websocket and :http types",
        ".track(payload) sends presence track",
        ".untrack sends presence untrack",
        "Presence state management: presences hash with sync/join/leave diffs"
      ],
      "priority": 22,
      "passes": false
    },
    {
      "id": "US-023",
      "title": "Realtime Client - Tests",
      "description": "As a developer, I want comprehensive tests for the Realtime client covering connection lifecycle, channels, broadcast, presence, CDC, heartbeat, and reconnection.",
      "acceptanceCriteria": [
        "Connection tests: connect, disconnect, reconnect with backoff",
        "Heartbeat tests: sent at interval, reconnect on missed reply",
        "Channel lifecycle tests: join, leave, rejoin after reconnect",
        "Broadcast tests: send/receive messages, self-broadcast config, HTTP fallback",
        "Presence tests: track, untrack, sync/join/leave events, state management",
        "PostgreSQL changes tests: INSERT/UPDATE/DELETE events, schema/table/filter binding",
        "Send buffer tests: messages queued when disconnected, flushed on connect",
        "Auth token tests: set_auth propagates to channels, access_token callback",
        "Error handling tests: channel join errors, server errors",
        "Message routing tests: correct channel receives correct messages",
        "Ref correlation tests: push/reply matching"
      ],
      "priority": 23,
      "passes": false
    },
    {
      "id": "US-024",
      "title": "Supabase Client - Top-Level Orchestrator",
      "description": "As a developer, I want a single Supabase::Client entry point that composes all service clients with shared authentication so that I can access all Supabase services through one interface.",
      "acceptanceCriteria": [
        "Supabase::Client.new(url, key, db: {}, auth: {}, realtime: {}, storage: {}, global: {}, access_token: nil) constructor (also aliased as Supabase.create_client(url, key, **opts))",
        "URL validation: rejects empty, non-HTTP(S), malformed URLs with specific error messages per spec",
        "API key validation: rejects empty/nil key",
        "Derives service URLs: /auth/v1, /rest/v1, wss://.../realtime/v1, /storage/v1, /functions/v1",
        "Storage key derived from URL hostname: sb-{hostname_first_part}-auth-token",
        "X-Client-Info: supabase-rb/{version} header on all requests",
        "Auth-wrapped fetch: injects apikey and Authorization: Bearer {token} headers on requests (only if not already present)",
        "Token resolution: prefers access_token callback over session; falls back to API key",
        "Session-based mode: initializes full AuthClient; registers auth event listener for Realtime token sync",
        "Third-party auth mode (access_token callback): auth property raises error on access; no event listener; Realtime gets initial token via set_auth",
        "Delegates: from(relation), schema(name), rpc(fn, ...) -\u003e PostgREST; channel(name), get_channels, remove_channel, remove_all_channels -\u003e Realtime",
        "functions accessor creates new FunctionsClient on each access (latest headers)",
        "storage accessor returns shared StorageClient",
        "auth accessor returns AuthClient (or raising proxy in third-party mode)",
        "Auth event propagation: TOKEN_REFRESHED/SIGNED_IN -\u003e realtime.set_auth(token) (with dedup); SIGNED_OUT -\u003e realtime.set_auth(nil)",
        "Configuration merge: user options \u003e computed defaults \u003e static defaults",
        "Deep-merge for db, auth, realtime, global sections"
      ],
      "priority": 24,
      "passes": false
    },
    {
      "id": "US-025",
      "title": "Supabase Client - Tests",
      "description": "As a developer, I want comprehensive tests for the top-level Supabase client covering constructor validation, URL derivation, auth modes, token propagation, and sub-client delegation.",
      "acceptanceCriteria": [
        "Constructor validation tests (CV-01 through CV-10)",
        "URL construction tests (UC-01 through UC-03)",
        "Storage key derivation tests (SK-01 through SK-03)",
        "Auth mode tests (AM-01 through AM-05)",
        "Auth-wrapped fetch tests (FW-01 through FW-06)",
        "Token propagation to Realtime tests (TP-01 through TP-06)",
        "Sub-client delegation tests (SD-01 through SD-10)",
        "Configuration defaults tests (CD-01 through CD-08)",
        "Environment detection / X-Client-Info tests"
      ],
      "priority": 25,
      "passes": false
    },
    {
      "id": "US-026",
      "title": "Documentation and Examples",
      "description": "As a developer, I want a README with installation instructions, usage examples, and API reference so that I can quickly get started with the SDK.",
      "acceptanceCriteria": [
        "Root README with overview, gem installation for each module, and quick start examples",
        "Per-gem README with detailed API documentation",
        "Usage examples: CRUD queries, auth flows, file uploads, realtime subscriptions, function invocations",
        "Example showing independent gem usage (e.g., using only supabase-postgrest)",
        "Example showing combined usage via the supabase gem",
        "YARD documentation on all public methods"
      ],
      "priority": 26,
      "passes": false
    }
  ]
}
