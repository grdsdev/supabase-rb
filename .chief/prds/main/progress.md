## Codebase Patterns
- Use `eval "$(rbenv init -)"` before running Ruby commands to ensure Ruby 3.3.0 is active (system Ruby is 2.6)
- Root Rakefile runs all gem specs via `bundle exec rake spec` with `-I gems/{name}/spec -I gems/{name}/lib` for proper load paths
- Each gem follows pattern: `gems/{name}/lib/supabase/{module}.rb` requires `{module}/version`
- VERSION constant lives at `Supabase::{Module}::VERSION` (top-level gem uses `Supabase::VERSION`)
- Gemspecs are excluded from rubocop via `**/*.gemspec` in `.rubocop.yml`
- HTTP gems depend on `faraday ~> 2.0`, WebSocket gem depends on `websocket-client-simple ~> 0.8`
- No cross-gem runtime dependencies (except top-level `supabase` gem which depends on all 5)
- All specs use webmock for HTTP stubbing
- `.rspec` files in each gem directory with `--require spec_helper`
- Rubocop ClassLength limit is 100 lines; extract modules to keep classes small
- Use `**options` keyword splat for methods with >5 params to satisfy `Metrics/ParameterLists`
- All client methods return `{ data:, error: }` result hashes (never raise by default)
- Error hierarchy pattern: BaseError < StandardError, then specific subclasses with `status:` and `context:` attrs
- Test files go in `gems/{name}/spec/supabase/{module}/` subdirectories (e.g., `client_spec.rb`)
- Constants defined in modules must be scoped to the module where they're used, not the including class (Ruby constant lookup goes to enclosing module first)
- Auth test pattern: helper `build_jwt(payload)` to create valid JWT tokens for testing; `session_response(overrides)` for mock API responses
- Split auth tests into 8 files by concern: client, sign_up, sign_in, session, events, admin, mfa, utilities
- WebMock: do NOT chain multiple `.to_return` on same stub (they cycle sequentially); use one `stub_request(...).to_return(...)` per test
- Rubocop `Naming/VariableNumber`: use normalcase for symbol numbers (`:ap_southeast1` not `:ap_southeast_1`)
- Faraday test adapter blocks must be multiline `do...end`, not single-line, to satisfy `Style/BlockDelimiters`
- PostgREST result hash: `{ data:, error:, count:, status:, status_text: }` (extends standard `{ data:, error: }` pattern)
- PostgREST Builder uses `**options` splat in `initialize(url:, **options)` to stay under 5 param limit
- Extract ResponseHandler module from Builder to stay under ClassLength 100 lines
- `Naming/MethodParameterName` requires 3+ chars; use `function_name` not `fn`
- `Lint/DuplicateBranch`: avoid `elsif` and `else` branches with same body; merge them
- CRUD methods return FilterBuilder (not QueryBuilder); QueryBuilder is the entry point, FilterBuilder chains further
- CrudBuilder module extracted from QueryBuilder to keep classes under 100 lines; pattern: extract `{Thing}Builder` module
- `Lint/UnusedBlockArgument`: prefix unused block args with `_` (e.g., `|_url, headers|`)
- FilterBuilder#select adds `Prefer: return=representation` for mutation results
- Bulk insert: `columns` param set from union of all Hash keys in array
- Filter methods mutate `@url` in-place and return `self` for chaining; use modules (Filters, RangeFilters) to split methods
- `Naming/PredicatePrefix` cop: use `rubocop:disable` inline for API-convention `is_*` methods that aren't predicates
- Transform methods (order, limit, range, single, csv, etc.) live in Transforms module included by FilterBuilder
- `Metrics/AbcSize`/`CyclomaticComplexity`: split methods with many boolean flags into helper + collector pattern
- `maybe_single` requires FilterBuilder#execute override for post-processing (unwrap array, synthesize PGRST116 error)
- Filter patterns with `%` (like/ilike) cause URI::InvalidURIError; test via `builder.url.query` instead of `stub_request` for those
- Text search queries with spaces get URL-encoded to `%20` by URI.parse; account for encoding in assertions
- Use `%r{}` instead of `//` for regexes containing slashes (Style/RegexpLiteral cop)
- Split large test suites into multiple files by concern (client, crud, filters, transforms, errors) for manageability
- `Style/KeywordParametersOrder`: required kwargs must come before optional kwargs in method signatures
- Storage API pattern: BucketApi module extracted from Client, StorageFileApi returned by `from(bucket_id)`
- Storage API endpoints: `/bucket` (list), `/bucket/{id}` (get/update/delete), `/bucket/{id}/empty` (empty)
- Storage file endpoints: `/object/{bucket}/{path}` (upload/update/download/exists), `/object/move`, `/object/copy`, `/object/info/{bucket}/{path}`
- StorageFileApi has independent HTTP helpers (not shared with Client); each class handles its own Faraday connections
- Storage upload headers use lowercase keys: `cache-control`, `content-type`, `x-upsert`, `x-metadata`
- Storage move/copy use camelCase JSON body keys: `bucketId`, `sourceKey`, `destinationBucket`, `destinationKey`
- Storage URL operations: signed URLs from `/object/sign/`, public URLs from `/object/public/`, image transforms from `/render/image/public/` or `/render/image/authenticated/`
- Storage list endpoint: POST to `/object/list/{bucket}` with body `{ prefix:, limit:, offset:, sortBy:, search: }`
- `get_public_url` is pure URL construction (no HTTP); all other URL methods make HTTP calls
- `Style/IfUnlessModifier`: use modifier form for single-line if bodies (e.g., `result[:key] = value if condition`)
- Auth error hierarchy: AuthError (base), AuthApiError, AuthRetryableFetchError, AuthUnknownError, AuthSessionMissingError, AuthInvalidTokenResponseError, AuthInvalidCredentialsError, AuthWeakPasswordError, AuthPKCEGrantCodeExchangeError
- Auth error classification: 502/503/504 -> AuthRetryableFetchError, 4xx+JSON -> AuthApiError, 4xx+non-JSON -> AuthUnknownError, Faraday::Error -> AuthRetryableFetchError(status: 0), weak_password code -> AuthWeakPasswordError
- Auth HTTP layer sends `X-Supabase-Api-Version: 2024-01-01` and `X-Client-Info: supabase-rb/{VERSION}` on all requests
- `Naming/AccessorMethodName` cop flags `get_*` methods; disable inline for API-convention names (`get_session`, `get_user`)
- `Naming/BlockForwarding` cop: use `&` anonymous forwarding (`def method(&)`) instead of named `&block` when just yielding
- `Lint/AmbiguousOperatorPrecedence`: wrap mixed `+` and `*` expressions with parentheses
- `Style/MutableConstant`: freeze interpolated string constants (`"supabase-rb/#{VERSION}".freeze`)
- Auth Client uses ErrorClassifier module to classify HTTP responses into error types, and HttpHandler module for HTTP layer
- Auth Session model computes `expires_at` from `expires_in` if not explicitly provided
- Auth sign-in/sign-up split into 3 modules: SignUpMethods, SignInMethods, VerifyMethods (included by Client)
- PKCE module uses `module_function` for stateless utility methods; verifier stored under `{storage_key}-code-verifier`
- Auth `handle_session_response` saves session + emits `:signed_in`; `handle_sign_up_response` distinguishes session vs confirmation
- OAuth `sign_in_with_oauth` builds URL synchronously (no HTTP); all other sign-in methods make HTTP calls
- Code verifier with `/PASSWORD_RECOVERY` suffix triggers `:password_recovery` event in `exchange_code_for_session`
- Auth Client module extraction pattern: SessionHelpers, SessionMethods, AutoRefresh, UserMethods all included by Client
- `Naming/AccessorMethodName` cop: `get_user(jwt: nil)` with params does NOT trigger the cop; only no-arg `get_*` triggers it
- Auth session management: `set_session` decodes JWT -> validates -> refreshes if expired -> saves -> emits SIGNED_IN + TOKEN_REFRESHED
- Auth auto-refresh: Thread-based, 30s interval, refresh when <= 3 ticks from expiry, exponential backoff (200ms base, max 10 retries)
- Auth sign_out: remove local session first, then POST /logout for non-local scopes (:global, :others)
- MFA API uses a separate class (MfaApi) accessed via `client.mfa`; communicates with Client via `@client.send(:private_method)`
- `Lint/UselessConstantScoping`: constants under `private` are flagged; place constants above `private` in class body
- `Style/MultipleComparison`: use `Array#include?` with frozen constant instead of chaining `||` comparisons
- Admin API uses separate class (AdminApi) accessed via `client.admin`; follows same pattern as MfaApi with AdminMethods module
- Admin endpoints: `/admin/users` (CRUD), `/invite` (email invite), `/admin/generate_link` (link generation), `/logout` (admin sign out with JWT param)
- `generate_link` extracts link properties (action_link, email_otp, hashed_token, redirect_to, verification_type) from response data
- Realtime Client uses `websocket-client-simple` gem; `WebSocket::Client::Simple.connect(url) { |ws| ws.on :open, :message, :close, :error }`
- Phoenix protocol: topic=`"phoenix"` for heartbeats, `"realtime:{name}"` for channels; events: `phx_join`, `phx_leave`, `phx_reply`, `phx_close`, `phx_error`
- Realtime modules: Heartbeat, Reconnect, ChannelMessageHandler extracted from Client/Channel to keep under ClassLength 100
- Realtime WebSocket testing: use `instance_double`/`allow+receive` mocks; don't require actual WebSocket connections
- Top-level `supabase` gem: Client split into modules (UrlBuilder, SubClients, Delegation, AuthTokenManager) + main Client class; uses `require "supabase/{name}"` for sub-gems
- Realtime client takes positional `url` arg; other clients use `url:` keyword arg
- `Hash#except` (Ruby 3.0+) for passing options while excluding specific keys

---

## 2026-02-10 - US-001
- What was implemented: Multi-gem monorepo scaffolding with 6 gems (supabase, supabase-auth, supabase-postgrest, supabase-realtime, supabase-storage, supabase-functions)
- Files changed:
  - Root: Gemfile, Gemfile.lock, Rakefile, .rubocop.yml, .rspec, .ruby-version, .gitignore
  - Per gem (x6): gemspec, Gemfile, .rspec, lib/{module}.rb, lib/{module}/version.rb, spec/spec_helper.rb, spec/{module}_spec.rb
- **Learnings for future iterations:**
  - System Ruby is 2.6; must use rbenv with `eval "$(rbenv init -)"` to get Ruby 3.3.0
  - Root `*.gemspec` glob only matches root-level gemspecs; use `**/*.gemspec` to exclude nested ones
  - Running rspec from root requires explicit `-I` flags for each gem's spec and lib dirs
  - Bundler resolves all 6 gemspecs from the root Gemfile via `gemspec path:` directives
---

## 2026-02-10 - US-002
- What was implemented: Functions Client core with error hierarchy, body auto-serialization, response parsing, region routing, header precedence, and all HTTP methods
- Files changed:
  - `gems/supabase-functions/lib/supabase/functions.rb` (added requires for errors, client)
  - `gems/supabase-functions/lib/supabase/functions/errors.rb` (new: FunctionsError, FunctionsFetchError, FunctionsRelayError, FunctionsHttpError)
  - `gems/supabase-functions/lib/supabase/functions/client.rb` (new: Client class with invoke, set_auth, body/response handling)
  - `gems/supabase-functions/lib/supabase/functions/response_handler.rb` (new: extracted response processing module)
  - `.chief/prds/main/prd.json` (marked US-002 as passes: true)
- **Learnings for future iterations:**
  - Rubocop ClassLength limit is 100 lines; extract modules (e.g., ResponseHandler) to keep classes under limit
  - `Naming/AccessorMethodName` cop flags `set_*` methods; use `rubocop:disable` inline when matching external API conventions (e.g., Supabase JS client's `set_auth`)
  - `invoke` uses `**options` keyword splat instead of 6 positional params to avoid `Metrics/ParameterLists` cop
  - Rescue specific exceptions (`Faraday::Error, IOError`) instead of broad `StandardError` to avoid `Lint/DuplicateBranch`
  - Response handler: `text/event-stream` returns raw Faraday response object (not body) per Supabase spec
---

## 2026-02-10 - US-003
- What was implemented: Comprehensive test suite for the Functions client (64 tests total)
- Files changed:
  - `gems/supabase-functions/spec/supabase/functions/client_spec.rb` (new: 64 tests covering all acceptance criteria)
  - `.chief/prds/main/prd.json` (marked US-003 as passes: true)
- **Test coverage areas:**
  - AU-01 through AU-05: Authentication / set_auth persistence
  - BH-01 through BH-08: Body auto-detection and serialization (String, Hash, Array, IO, StringIO, nil, nested, empty)
  - RP-01 through RP-08: Response parsing (JSON, JSON array, text/plain, octet-stream, event-stream, charset, unknown, missing)
  - EH-01 through EH-08: Error handling (HttpError, RelayError, FetchError, network, timeout, context)
  - RR-01 through RR-05: Region routing (default :any, client-level, invoke-level override, :any override, symbol conversion)
  - TC-01 through TC-05: Timeout behavior (default, per-request, expiry, custom fetch with/without timeout)
  - HP-01 through HP-03: Header precedence (invoke > client > auto-detected)
  - HM-01 through HM-05: HTTP methods (POST, GET, PUT, PATCH, DELETE)
  - Error hierarchy tests, constructor tests, invalid method test, 5 integration scenarios
- **Learnings for future iterations:**
  - WebMock `.to_return` calls are additive (cycle through responses); never chain a helper that calls `.to_return` with another `.to_return`
  - Use direct `stub_request(:method, url).to_return(...)` in each test for clarity; avoid helpers with default responses
  - Rubocop `Naming/VariableNumber` applies to symbols too: `:ap_southeast1` not `:ap_southeast_1`
  - Faraday test adapter: use multiline `do...end` blocks to satisfy `Style/BlockDelimiters` and `Style/SingleLineDoEndBlock`
---

## 2026-02-10 - US-004
- What was implemented: PostgREST Client core builder infrastructure with error hierarchy, builder base class, query builder, response handler, and client with from/schema/rpc
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (added requires for errors, builder, query_builder, client)
  - `gems/supabase-postgrest/lib/supabase/postgrest/errors.rb` (new: PostgrestError with message, details, hint, code)
  - `gems/supabase-postgrest/lib/supabase/postgrest/response_handler.rb` (new: extracted response parsing, error handling, count parsing)
  - `gems/supabase-postgrest/lib/supabase/postgrest/builder.rb` (new: base Builder class with execute, schema headers, throw_on_error, dup_with)
  - `gems/supabase-postgrest/lib/supabase/postgrest/query_builder.rb` (new: QueryBuilder < Builder scoped to table)
  - `gems/supabase-postgrest/lib/supabase/postgrest/client.rb` (new: Client with from(), schema(), rpc())
  - `.chief/prds/main/prd.json` (marked US-004 as passes: true)
- **Learnings for future iterations:**
  - Builder uses `initialize(url:, **options)` pattern to keep params under 5; QueryBuilder passes options through via `super(url:, **options)`
  - ResponseHandler module extracted from Builder to keep class under 100 lines; includes build_result, parse_error, parse_data, parse_count, handle_fetch_error
  - PostgREST result hash adds count, status, status_text beyond the standard { data:, error: } pattern
  - `Naming/MethodParameterName` cop requires 3+ character param names; renamed `fn` to `function_name`
  - `Lint/DuplicateBranch`: text/csv and else both returned response.body, merged into single else branch
  - Builder#dup_with is the immutability mechanism: dups URL and headers to ensure independence
  - Schema headers: Accept-Profile for GET/HEAD, Content-Profile for POST/PATCH/DELETE
---

## 2026-02-10 - US-005
- What was implemented: PostgREST CRUD operations (select, insert, update, upsert, delete) with FilterBuilder for mutation chaining
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest/crud_builder.rb` (new: CrudBuilder module with select, insert, update, upsert, delete methods)
  - `gems/supabase-postgrest/lib/supabase/postgrest/filter_builder.rb` (new: FilterBuilder < Builder with .select for return=representation)
  - `gems/supabase-postgrest/lib/supabase/postgrest/query_builder.rb` (updated: includes CrudBuilder module)
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (updated: added requires for filter_builder and crud_builder)
  - `.chief/prds/main/prd.json` (marked US-005 as passes: true)
- **Implementation details:**
  - QueryBuilder includes CrudBuilder module with select, insert, update, upsert, delete
  - Each CRUD method returns a FilterBuilder (for chaining filters/transforms in US-006/US-007)
  - FilterBuilder#select adds `Prefer: return=representation` and `?select=` for mutation results
  - Bulk insert (Array of Hashes) auto-sets `columns` query param from union of all Hash keys
  - Upsert sets `Prefer: resolution=merge-duplicates` (default) or `resolution=ignore-duplicates`
  - `default_to_null: false` adds `Prefer: missing=default`
  - `on_conflict` sets the `on_conflict` query param for upserts
  - `count` option adds `Prefer: count={algorithm}` header for all operations
  - `head: true` on select uses HEAD method
- **Learnings for future iterations:**
  - Extract CRUD methods into CrudBuilder module to keep QueryBuilder small (rubocop ClassLength)
  - FilterBuilder extends Builder so it inherits execute/schema headers/throw_on_error
  - Use `_url` prefix for unused block args to satisfy `Lint/UnusedBlockArgument`
  - `dup_with` pattern from Builder reused in FilterBuilder for immutable .select chaining
---

## 2026-02-10 - US-006
- What was implemented: PostgREST Filter Builder with all comparison, pattern, regex, collection, range, text search, and compound filter methods
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest/filters.rb` (new: Filters module with eq, neq, gt, gte, lt, lte, is, is_distinct, like, ilike, like_all_of, like_any_of, ilike_all_of, ilike_any_of, match, imatch, in, contains, contained_by, overlaps)
  - `gems/supabase-postgrest/lib/supabase/postgrest/range_filters.rb` (new: RangeFilters module with range_gt, range_gte, range_lt, range_lte, range_adjacent, text_search, match_filter, not, or, filter)
  - `gems/supabase-postgrest/lib/supabase/postgrest/filter_builder.rb` (updated: includes Filters and RangeFilters modules, added private helpers append_filter, quote_filter_value, format_containment)
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (updated: added requires for filters and range_filters)
  - `.chief/prds/main/prd.json` (marked US-006 as passes: true)
- **Learnings for future iterations:**
  - `Naming/PredicatePrefix` cop flags `is_*` methods as predicates; use `rubocop:disable` inline for PostgREST API-convention method names like `is_distinct`
  - Filter methods mutate `@url` in-place and return `self` for chaining (not immutable like `select`)
  - Extract filter methods into multiple modules (Filters, RangeFilters) to stay under ClassLength 100 limit
  - `in` filter: values with reserved chars (comma, parens, quotes) must be quoted with escaped double quotes
  - `contains`/`contained_by`/`overlaps`: Array becomes `{a,b}`, Hash becomes JSON-serialized string
  - `or` filter uses `key=(filters)` format; with `referenced_table`, key becomes `table.or`
  - `match_filter` applies multiple `eq` filters from a Hash
  - `text_search` operator mapping: nil->fts, :plain->plfts, :phrase->phfts, :websearch->wfts; config appended as `op(config)`
---

## 2026-02-10 - US-007
- What was implemented: PostgREST Transform Builder with order, limit, range, single, maybe_single, csv, geojson, explain, rollback, and max_affected methods
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest/transforms.rb` (new: Transforms module with all transform methods)
  - `gems/supabase-postgrest/lib/supabase/postgrest/filter_builder.rb` (updated: includes Transforms module, added execute override for maybe_single, added handle_maybe_single)
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (updated: added require for transforms)
  - `.chief/prds/main/prd.json` (marked US-007 as passes: true)
- **Implementation details:**
  - Transforms module extracted to keep FilterBuilder under 100 lines (same pattern as Filters/RangeFilters)
  - `order` supports multiple calls by appending to existing order param (comma-separated)
  - `range(from, to)` converts to offset + limit params (0-based inclusive: limit = to - from + 1)
  - `single` sets Accept: application/vnd.pgrst.object+json; PostgREST errors on != 1 row
  - `maybe_single` sets same Accept header + @maybe_single flag; execute override unwraps arrays and synthesizes PGRST116 error on >1 row
  - `explain` builds Accept header with `for="explain"` prefix and pipe-separated options
  - `rollback` and `max_affected` append to Prefer header
  - Transform methods mutate `@headers`/`@url` in-place and return `self` for chaining (same as filter methods)
- **Learnings for future iterations:**
  - `Metrics/AbcSize` and `CyclomaticComplexity`: split methods with many boolean flags into helper + collector (e.g., `build_explain_header` + `collect_explain_parts`)
  - `Lint/DuplicateBranch`: remove redundant if/else with same body (e.g., maybe_single had identical branches for GET vs non-GET)
  - `order` appending: use regex gsub on existing query string to append comma-separated values to existing `order=` param
  - `maybe_single` needs FilterBuilder#execute override (not Builder) since it's post-processing logic specific to the result
---

## 2026-02-10 - US-008
- What was implemented: Comprehensive test suite for the PostgREST client (127 tests total across 4 test files)
- Files changed:
  - `gems/supabase-postgrest/spec/supabase/postgrest/client_spec.rb` (new: CI-01 through CI-06, from/schema/RPC tests, SC-01 through SC-04, RP-01 through RP-07)
  - `gems/supabase-postgrest/spec/supabase/postgrest/crud_spec.rb` (new: SE-01 through SE-07, IN-01 through IN-05, UP-01 through UP-02, US-01 through US-03, DE-01 through DE-03)
  - `gems/supabase-postgrest/spec/supabase/postgrest/filters_spec.rb` (new: FI-01 through FI-25, range filters, text search, compound filters)
  - `gems/supabase-postgrest/spec/supabase/postgrest/transforms_spec.rb` (new: TR-01 through TR-17, explain, rollback, max_affected)
  - `gems/supabase-postgrest/spec/supabase/postgrest/errors_spec.rb` (new: EH-01 through EH-08, BI-01 through BI-03, response parsing, custom fetch, error hierarchy)
  - `.chief/prds/main/prd.json` (marked US-008 as passes: true)
- **Test coverage areas:**
  - Client initialization (CI-01 through CI-06)
  - SELECT operations (SE-01 through SE-07)
  - INSERT operations (IN-01 through IN-05)
  - UPDATE operations (UP-01 through UP-02)
  - UPSERT operations (US-01 through US-03)
  - DELETE operations (DE-01 through DE-03)
  - All filters (FI-01 through FI-25): eq, neq, gt, gte, lt, lte, is, is_distinct, like, ilike, like_all_of, like_any_of, ilike_all_of, ilike_any_of, match, imatch, in, contains, contained_by, overlaps, chaining
  - Range filters: range_gt, range_gte, range_lt, range_lte, range_adjacent
  - Text search: fts, plfts, phfts, wfts with config
  - Compound filters: match_filter, not, or, filter
  - All transforms (TR-01 through TR-17): order, limit, range, single, maybe_single, csv, geojson, explain, rollback, max_affected
  - RPC (RP-01 through RP-07): POST/GET/HEAD, count, schema
  - Error handling (EH-01 through EH-08): JSON errors, non-JSON errors, network errors, timeout, throw_on_error
  - Schema switching (SC-01 through SC-04): Accept-Profile, Content-Profile
  - Builder immutability (BI-01 through BI-03): from() independence, throw_on_error copies, select copies
  - Response parsing: JSON, vnd.pgrst, CSV, Content-Range count
  - URL construction validation across all test categories
- **Learnings for future iterations:**
  - Split tests into multiple files (client, crud, filters, transforms, errors) to keep files manageable
  - Patterns with `%` chars in like/ilike filter tests cause URI::InvalidURIError when used via `append_query_param` with URI.parse; test query string assertions instead of HTTP stubs for those patterns
  - Text search queries with spaces get URL-encoded by URI.parse; match against `%20` in query string assertions
  - Use `%r{}` instead of `//` for regexes with slashes (Style/RegexpLiteral cop)
  - Unused variable assignments in tests trigger `Lint/UselessAssignment`; omit the assignment if the return value isn't checked
---

## 2026-02-10 - US-009
- What was implemented: Storage Client core with error hierarchy, bucket management API, and StorageFileApi stub
- Files changed:
  - `gems/supabase-storage/lib/supabase/storage.rb` (updated: added requires for errors and client)
  - `gems/supabase-storage/lib/supabase/storage/errors.rb` (new: StorageError, StorageApiError, StorageUnknownError)
  - `gems/supabase-storage/lib/supabase/storage/client.rb` (new: Client with from(), bucket management delegation, HTTP helpers)
  - `gems/supabase-storage/lib/supabase/storage/bucket_api.rb` (new: BucketApi module with list_buckets, get_bucket, create_bucket, update_bucket, empty_bucket, delete_bucket)
  - `gems/supabase-storage/lib/supabase/storage/storage_file_api.rb` (new: StorageFileApi stub class for file operations)
  - `.chief/prds/main/prd.json` (marked US-009 as passes: true)
- **Implementation details:**
  - Error hierarchy follows same pattern as Functions: base StorageError < StandardError with `context:`, subclasses add `status:`
  - StorageApiError for HTTP errors (non-2xx), StorageUnknownError for network/Faraday failures
  - BucketApi module extracted from Client to keep classes under 100 lines (ClassLength cop)
  - Client delegates bucket methods via `include BucketApi`; `from(bucket_id)` returns a StorageFileApi scoped to the bucket
  - All bucket methods return `{ data:, error: }` pattern; rescue Faraday::Error for network failures
  - JSON responses auto-parsed; error messages extracted from JSON `message` or `error` keys
  - StorageFileApi is a stub with `initialize(url:, bucket_id:, headers: {}, fetch: nil)` ready for US-010/US-011
- **Learnings for future iterations:**
  - `Style/KeywordParametersOrder`: required kwargs must come before optional kwargs (e.g., `bucket_id:` before `headers: {}`)
  - Storage API endpoints: `/bucket` for list, `/bucket/{id}` for get/update/delete, `/bucket/{id}/empty` for empty
  - `create_bucket` sends both `id` and `name` fields (both set to the bucket_id)
  - `update_bucket` requires `public:` field in the body
  - Running specs from root requires `bundle exec rake supabase_storage:spec` (not direct `rspec` which lacks `-I` flags)
---

## 2026-02-10 - US-010
- What was implemented: Storage Client file operations (upload, update, download, move, copy, remove, info, exists?) with path normalization
- Files changed:
  - `gems/supabase-storage/lib/supabase/storage/file_operations.rb` (new: FileOperations module with upload, update, download, move, copy, remove, info, exists?)
  - `gems/supabase-storage/lib/supabase/storage/storage_file_api.rb` (updated: includes FileOperations, added private helpers for path normalization, upload headers, body reading, download URLs, HTTP, response handling)
  - `.chief/prds/main/prd.json` (marked US-010 as passes: true)
- **Implementation details:**
  - FileOperations module extracted from StorageFileApi to keep class under 100 lines
  - `upload` sends POST to `/object/{bucket}/{path}` with cache-control, content-type, x-upsert, x-metadata headers
  - `update` sends PUT to same endpoint (replaces file)
  - `download` sends GET to `/object/{bucket}/{path}`; with transform uses `/render/image/authenticated/{bucket}/{path}?{params}`
  - `move` sends POST to `/object/move` with bucketId, sourceKey, destinationBucket, destinationKey
  - `copy` sends POST to `/object/copy` with same body structure
  - `remove` sends DELETE to `/object/{bucket}` with `{ prefixes: paths }` body
  - `info` sends GET to `/object/info/{bucket}/{path}`
  - `exists?` sends HEAD to `/object/{bucket}/{path}`, returns boolean based on status
  - Path normalization: strips leading/trailing slashes, collapses consecutive slashes
  - Body reading: IO/StringIO read via `.read`, String via `.to_s`
  - Default content-type is `application/octet-stream`
- **Learnings for future iterations:**
  - StorageFileApi has its own HTTP helpers (perform_request, build_connection, handle_response) independent of Client
  - FileOperations module pattern follows same extraction as BucketApi, Filters, RangeFilters, Transforms, CrudBuilder
  - Upload headers use lowercase keys (`cache-control`, `content-type`, `x-upsert`, `x-metadata`) per Supabase convention
  - `move` and `copy` use camelCase keys in JSON body (bucketId, sourceKey, etc.) to match Supabase API
  - `exists?` uses HEAD method and checks status range; returns `{ data: true/false, error: nil }`
  - `download` returns raw binary body (not JSON-parsed) in `{ data: body, error: nil }`
---

## 2026-02-10 - US-011
- What was implemented: Storage Client URL operations and file listing (create_signed_url, create_signed_urls, create_signed_upload_url, upload_to_signed_url, get_public_url, list) with image transform support
- Files changed:
  - `gems/supabase-storage/lib/supabase/storage/url_operations.rb` (new: UrlOperations module with all URL and listing methods)
  - `gems/supabase-storage/lib/supabase/storage/storage_file_api.rb` (updated: includes UrlOperations module)
  - `.chief/prds/main/prd.json` (marked US-011 as passes: true)
- **Implementation details:**
  - `create_signed_url` sends POST to `/object/sign/{bucket}/{path}` with expiresIn and optional transform; returns full signed URL
  - `create_signed_urls` sends POST to `/object/sign` (batch) with paths prefixed by bucket_id
  - `create_signed_upload_url` sends POST to `/object/upload/sign/{bucket}/{path}` with optional x-upsert header; returns signed_url + token + path
  - `upload_to_signed_url` sends PUT to `/object/upload/sign/{bucket}/{path}?token=` with upload headers
  - `get_public_url` is synchronous (no HTTP call); uses `/render/image/public/` for transforms, `/object/public/` otherwise
  - `list` sends POST to `/object/list/{bucket}` with prefix, limit, offset, sortBy, search body
  - Image transform params (width, height, resize, quality, format) appended as query params
  - Download param: `download=` (boolean true) or `download={filename}` (string); URI-encoded
  - Signed URL download param uses separator logic (? vs &) since signed URLs already have query params
- **Learnings for future iterations:**
  - UrlOperations module follows same extraction pattern as FileOperations, BucketApi, Filters, etc.
  - Module was initially 104 lines (over 100 limit); compacted by inlining small helpers and removing intermediate variables
  - `Style/IfUnlessModifier` cop: single-line if bodies should use modifier form (`result[:key] = value if condition`)
  - Signed URL API returns `signedURL` (camelCase) in response JSON
  - Batch signed URLs endpoint is `/object/sign` (no bucket/path in URL); paths are passed in body with bucket prefix
  - Signed upload URL response has `url` field as relative path; must be prepended with base URL
  - `get_public_url` never makes HTTP calls - it's pure URL construction
  - `list` uses `sortBy` (camelCase) in request body to match Supabase API convention
---

## 2026-02-10 - US-012
- What was implemented: Comprehensive test suite for the Storage client (91 tests across 5 test files)
- Files changed:
  - `gems/supabase-storage/spec/supabase/storage/client_spec.rb` (new: client initialization and from() tests)
  - `gems/supabase-storage/spec/supabase/storage/bucket_api_spec.rb` (new: BM-01 through BM-09 bucket management tests)
  - `gems/supabase-storage/spec/supabase/storage/file_operations_spec.rb` (new: UL-01 through UL-12, DL-01 through DL-06, FO-01 through FO-07)
  - `gems/supabase-storage/spec/supabase/storage/url_operations_spec.rb` (new: SU-01 through SU-07, PU-01 through PU-04, FL-01 through FL-06, signed upload URLs)
  - `gems/supabase-storage/spec/supabase/storage/errors_spec.rb` (new: EH-01 through EH-04, path normalization, image transform params)
  - `.chief/prds/main/prd.json` (marked US-012 as passes: true)
- **Test coverage areas:**
  - Bucket management (BM-01 through BM-09): list, get, create, update, empty, delete with success/error/network failure
  - Upload tests (UL-01 through UL-12): string/IO body, cache control, content type, upsert, metadata, path normalization, errors, update via PUT
  - Download tests (DL-01 through DL-06): basic download, binary body, transforms with render/image/authenticated path, errors, path normalization
  - Signed URL tests (SU-01 through SU-07): single/batch signed URLs, download param (boolean/filename), transforms, errors
  - Public URL tests (PU-01 through PU-04): basic URL, download param, image transforms using render/image/public path
  - File operations (FO-01 through FO-07): move (same/different bucket), copy (same/different bucket), remove, info, exists?
  - File listing tests (FL-01 through FL-06): defaults, path prefix, limit/offset, sort, search, errors
  - Error handling (EH-01 through EH-04): error hierarchy, JSON/non-JSON error extraction, network failures, timeouts
  - Path normalization: leading/trailing slashes, consecutive slashes, empty path
  - Image transform params: width, height, resize, quality, format, render/image/public and render/image/authenticated paths
- **Learnings for future iterations:**
  - `empty_bucket` sends `JSON.generate({})` which is `"{}"` (string); stub with `body: "{}"` not `body: "{}".to_json` (which double-encodes)
  - WebMock body matching: when implementation uses `JSON.generate(body)`, stub with the exact JSON string, not `.to_json` on the expected hash (which may produce different key ordering or encoding)
  - Split storage tests across 5 files by concern: client, bucket_api, file_operations, url_operations, errors
  - `hash_including` matcher in WebMock works well for asserting partial body matches (e.g., FL-02 through FL-05)
  - Rubocop `Style/StringLiterals`: prefer double-quoted strings even for `'{}'` literal
---

## 2026-02-10 - US-013
- What was implemented: Auth Client core infrastructure with error hierarchy, storage adapter, session model, JWT decoder, lock mechanism, HTTP handler, error classifier, and Client class
- Files changed:
  - `gems/supabase-auth/lib/supabase/auth.rb` (updated: added requires for all new modules)
  - `gems/supabase-auth/lib/supabase/auth/errors.rb` (new: AuthError, AuthApiError, AuthRetryableFetchError, AuthUnknownError, AuthSessionMissingError, AuthInvalidTokenResponseError, AuthInvalidCredentialsError, AuthWeakPasswordError, AuthPKCEGrantCodeExchangeError, ErrorGuards module)
  - `gems/supabase-auth/lib/supabase/auth/memory_storage.rb` (new: MemoryStorage with get_item/set_item/remove_item)
  - `gems/supabase-auth/lib/supabase/auth/session.rb` (new: Session model with expires_at computation, to_h, expired?)
  - `gems/supabase-auth/lib/supabase/auth/jwt.rb` (new: JWT module with decode and base64url_decode)
  - `gems/supabase-auth/lib/supabase/auth/lock.rb` (new: Lock class with mutex-based with_lock and configurable timeout)
  - `gems/supabase-auth/lib/supabase/auth/error_classifier.rb` (new: ErrorClassifier module for HTTP response classification)
  - `gems/supabase-auth/lib/supabase/auth/http_handler.rb` (new: HttpHandler module with request, build_connection, default_headers)
  - `gems/supabase-auth/lib/supabase/auth/client.rb` (new: Client class with constructor, get_session, get_user, session management)
  - `.chief/prds/main/prd.json` (marked US-013 as passes: true)
- **Learnings for future iterations:**
  - Auth Client uses `**options` in constructor to keep under ParameterLists limit (same pattern as Functions/PostgREST)
  - `Naming/AccessorMethodName` cop flags `get_*` methods; use `rubocop:disable` inline for API-convention names like `get_session`
  - `Naming/BlockForwarding` cop: use `&` anonymous forwarding (`def with_lock(&)`) instead of named `&block` when just yielding
  - `Style/Next` cop: prefer `next if condition` over `unless condition` inside loops for skip-iteration logic
  - `Lint/AmbiguousOperatorPrecedence`: wrap mixed `+` and `*` expressions with parentheses (e.g., base64 padding calc)
  - `Style/MutableConstant`: freeze interpolated string constants (`"supabase-rb/#{VERSION}".freeze`)
  - ErrorClassifier extracts error codes from `error_code`, `code` keys; messages from `msg`, `message`, `error_description`, `error` keys
  - Auth error classification: 502/503/504 -> AuthRetryableFetchError, 4xx+JSON -> AuthApiError, 4xx+non-JSON -> AuthUnknownError, Faraday::Error -> AuthRetryableFetchError(status: 0)
  - weak_password code produces AuthWeakPasswordError with `reasons` array from `weak_password.reasons`
  - Session model computes `expires_at` from `expires_in` if not explicitly provided
  - Lock uses `Mutex#try_lock` + sleep loop instead of blocking `synchronize` to support configurable timeout
---

## 2026-02-10 - US-014
- What was implemented: Auth Client sign-up and sign-in methods (password, OAuth, OTP, ID token, SSO, anonymous) with PKCE support and OTP verification/code exchange
- Files changed:
  - `gems/supabase-auth/lib/supabase/auth.rb` (updated: added require for pkce module)
  - `gems/supabase-auth/lib/supabase/auth/client.rb` (updated: added requires for sign_up_methods, sign_in_methods, verify_methods; includes modules)
  - `gems/supabase-auth/lib/supabase/auth/pkce.rb` (new: PKCE module with generate_code_verifier, generate_code_challenge, challenge_method)
  - `gems/supabase-auth/lib/supabase/auth/sign_up_methods.rb` (new: SignUpMethods module with sign_up, sign_in_anonymously, helper methods)
  - `gems/supabase-auth/lib/supabase/auth/sign_in_methods.rb` (new: SignInMethods module with sign_in_with_password, sign_in_with_oauth, sign_in_with_otp, sign_in_with_id_token, sign_in_with_sso)
  - `gems/supabase-auth/lib/supabase/auth/verify_methods.rb` (new: VerifyMethods module with verify_otp, exchange_code_for_session)
  - `.chief/prds/main/prd.json` (marked US-014 as passes: true)
- **Implementation details:**
  - SignUpMethods: sign_up validates email/phone presence, includes PKCE params when flow_type is :pkce, handles session vs confirmation responses
  - SignInMethods: sign_in_with_password POST to /token?grant_type=password; sign_in_with_oauth builds authorize URL (no HTTP); sign_in_with_otp POST to /otp with PKCE; sign_in_with_id_token POST to /token?grant_type=id_token; sign_in_with_sso POST to /sso with PKCE
  - VerifyMethods: verify_otp POST to /verify with session handling; exchange_code_for_session retrieves/deletes stored verifier, POST to /token?grant_type=pkce, emits PASSWORD_RECOVERY or SIGNED_IN based on verifier suffix
  - PKCE: 56 random bytes -> 112-char hex verifier, SHA-256 -> base64url challenge, stored under {storage_key}-code-verifier
  - Shared helpers: handle_session_response saves session and emits SIGNED_IN; handle_sign_up_response distinguishes session vs confirmation; append_captcha adds gotrue_meta_security; append_pkce_params stores verifier and adds challenge params
- **Learnings for future iterations:**
  - Auth sign-in/sign-up methods split into 3 modules (SignUpMethods, SignInMethods, VerifyMethods) to keep under ClassLength 100 limit
  - PKCE module uses `module_function` pattern for stateless utility methods (same as ErrorClassifier)
  - `append_pkce_params` lives in SignUpMethods since it's used by both sign_up and sign_in methods (shared via include)
  - OAuth sign_in builds URL synchronously (no HTTP call); all other sign-in methods make HTTP calls
  - Code verifier with `/PASSWORD_RECOVERY` suffix triggers `:password_recovery` event instead of `:signed_in`
  - `exchange_code_for_session` strips the suffix before sending to API, but uses original verifier for event detection
---

## 2026-02-10 - US-015
- What was implemented: Auth Client session management (set_session, refresh_session, sign_out), auto-refresh background thread, and user management methods (update_user, reset_password_for_email, reauthenticate, resend)
- Files changed:
  - `gems/supabase-auth/lib/supabase/auth/client.rb` (updated: added includes for new modules, extracted private helpers to SessionHelpers, added auto-refresh instance vars, fixed get_user response wrapping)
  - `gems/supabase-auth/lib/supabase/auth/session_helpers.rb` (new: extracted load_session, save_session, remove_session, session_needs_refresh?, current_access_token, refresh_access_token, emit_event, log_debug)
  - `gems/supabase-auth/lib/supabase/auth/session_methods.rb` (new: SessionMethods module with set_session, refresh_session, sign_out, plus private helpers token_expired?, build_and_save_session, refresh_and_save)
  - `gems/supabase-auth/lib/supabase/auth/auto_refresh.rb` (new: AutoRefresh module with start_auto_refresh, stop_auto_refresh, background thread loop, exponential backoff retry)
  - `gems/supabase-auth/lib/supabase/auth/user_methods.rb` (new: UserMethods module with update_user, reset_password_for_email, reauthenticate, resend)
  - `.chief/prds/main/prd.json` (marked US-015 as passes: true)
- **Implementation details:**
  - `set_session` decodes JWT, validates structure, refreshes if expired, saves session, emits SIGNED_IN and TOKEN_REFRESHED
  - `refresh_session` uses provided or stored refresh token; POST /token?grant_type=refresh_token
  - `sign_out` supports scopes :global, :local, :others; removes local session, stops auto-refresh, emits SIGNED_OUT; POST /logout for non-local scopes
  - Auto-refresh: background Thread checks every 30s; refreshes when <= 3 ticks from expiry; exponential backoff (200ms base, doubles, max 10 retries); only retries AuthRetryableFetchError
  - `update_user` emits USER_UPDATED on success
  - `reset_password_for_email` POST /recover with optional redirect_to and captcha_token
  - `reauthenticate` GET /reauthenticate
  - `resend` POST /resend with type, email/phone
  - SessionHelpers module extracted from Client to keep class under 100 lines
- **Learnings for future iterations:**
  - Extract private helpers into modules (SessionHelpers) to keep Client class under ClassLength 100 lines
  - `Naming/AccessorMethodName` cop: `get_user(jwt: nil)` with params doesn't trigger the cop (only no-arg `get_*` triggers); `set_session` also doesn't trigger it
  - `Metrics/MethodLength` (max 20): split large methods by extracting helpers like `token_expired?` and `build_and_save_session`
  - `Style/IfUnlessModifier`: use modifier form for single-line conditional returns
  - Auto-refresh uses `Thread.new` + `@auto_refresh_running` flag for graceful stop
  - `sign_out` calls `stop_auto_refresh` directly (module included, no need for `respond_to?` check)
---

## 2026-02-10 - US-017
- What was implemented: Auth Client MFA API with enroll, challenge, verify, unenroll, challenge_and_verify, list_factors, and get_authenticator_assurance_level
- Files changed:
  - `gems/supabase-auth/lib/supabase/auth/mfa_api.rb` (new: MfaApi class with all MFA methods)
  - `gems/supabase-auth/lib/supabase/auth/mfa_methods.rb` (new: MfaMethods module with mfa accessor and internal helpers)
  - `gems/supabase-auth/lib/supabase/auth/client.rb` (updated: added requires and includes for MFA modules)
  - `.chief/prds/main/prd.json` (marked US-017 as passes: true)
- **Implementation details:**
  - MfaApi is a separate class (not a module) that receives the Client instance; accessed via `client.mfa`
  - `enroll` sends POST /factors with factor_type, optional friendly_name, issuer, phone
  - `challenge` sends POST /factors/{id}/challenge
  - `verify` sends POST /factors/{id}/verify; saves aal2 session and emits :mfa_challenge_verified
  - `unenroll` sends DELETE /factors/{id}
  - `challenge_and_verify` is a convenience combining challenge + verify in one call
  - `list_factors` calls get_user, extracts factors array, categorizes into :all, :totp, :phone (verified only)
  - `get_authenticator_assurance_level` decodes JWT from current session, reads aal/amr claims, computes current/next levels
  - MfaMethods module provides `mfa` accessor (lazy-initialized) and private helpers `mfa_request`, `handle_mfa_verify`
  - MfaApi communicates with Client via `@client.send(:private_method)` for authenticated requests
- **Learnings for future iterations:**
  - MFA uses a separate class (MfaApi) rather than a module because it needs its own state (@client reference) and acts as a namespace
  - `Lint/UselessConstantScoping`: constants under `private` get flagged; move constants above `private` in the class body
  - `Metrics/AbcSize`/`CyclomaticComplexity`: extract factor filtering into helpers (`extract_factors`, `categorize_factors`, `verified_factors_by_type`)
  - `Style/MultipleComparison`: use `Array#include?` with a frozen constant instead of `||` comparisons (e.g., `MFA_METHODS.include?(entry["method"])`)
  - AAL computation: aal1 -> aal2 only when no MFA method is present in amr; if MFA already in amr, next_level == current_level
---

## 2026-02-10 - US-018
- What was implemented: Auth Client Admin API with create_user, list_users, get_user_by_id, update_user_by_id, delete_user, invite_user_by_email, generate_link, and admin sign_out
- Files changed:
  - `gems/supabase-auth/lib/supabase/auth/admin_api.rb` (new: AdminApi class with all admin user management methods)
  - `gems/supabase-auth/lib/supabase/auth/admin_methods.rb` (new: AdminMethods module with admin accessor and admin_request helper)
  - `gems/supabase-auth/lib/supabase/auth/client.rb` (updated: added requires and includes for AdminApi/AdminMethods)
  - `.chief/prds/main/prd.json` (marked US-018 as passes: true)
- **Implementation details:**
  - AdminApi follows same pattern as MfaApi: separate class accessed via `client.admin`, communicates with Client via `@client.send(:admin_request)`
  - AdminMethods module provides `admin` accessor (lazy-initialized) and `admin_request` private helper
  - `admin_request` uses the apikey header or Authorization header as the token (service role key)
  - `create_user` body split into `build_create_user_credentials` + `apply_create_user_metadata` to satisfy AbcSize/CyclomaticComplexity cops
  - `list_users` builds query string from page/per_page params using URI.encode_www_form
  - `generate_link` extracts link properties (action_link, email_otp, hashed_token, redirect_to, verification_type) from response and returns them in a `properties` key
  - `delete_user` sends `should_soft_delete` in body
  - `sign_out` accepts a JWT and scope param; posts to /logout with the provided JWT
- **Learnings for future iterations:**
  - `Naming/AccessorMethodName` cop: `get_user_by_id(uid)` with a param does NOT trigger the cop; no rubocop:disable needed (unlike no-arg `get_*` methods)
  - `build_create_user_body` with 8 conditional assignments triggers AbcSize (28.65 > 17) and CyclomaticComplexity (9 > 7); split into credential + metadata helpers
  - Admin API pattern mirrors MFA API: separate class + integration module, lazy initialization via accessor
  - Admin endpoints: `/admin/users` (CRUD), `/invite` (invite), `/admin/generate_link` (link generation), `/logout` (sign out)
---

## 2026-02-10 - US-019
- What was implemented: PKCE flow completion - added password recovery PKCE support and resend PKCE support
- Files changed:
  - `gems/supabase-auth/lib/supabase/auth/user_methods.rb` (updated: `reset_password_for_email` now includes PKCE code_challenge and stores verifier with `/PASSWORD_RECOVERY` suffix when flow_type is :pkce; `resend` now includes PKCE code_challenge when flow_type is :pkce; added `append_pkce_recovery_params` private helper)
  - `.chief/prds/main/prd.json` (marked US-019 as passes: true)
- **Implementation details:**
  - Most PKCE infrastructure was already in place from US-014 (PKCE module, `append_pkce_params`, `exchange_code_for_session`, OAuth/OTP/SSO/sign_up PKCE integration)
  - Added `append_pkce_recovery_params` to UserMethods: generates verifier, stores it with `/PASSWORD_RECOVERY` suffix, adds code_challenge + code_challenge_method to request body
  - The `/PASSWORD_RECOVERY` suffix on the stored verifier enables `exchange_code_for_session` (in VerifyMethods) to detect password recovery flow and emit `:password_recovery` event instead of `:signed_in`
  - Added PKCE support to `resend` method using existing `append_pkce_params` from SignUpMethods (available since all modules are included in Client)
- **Learnings for future iterations:**
  - PKCE recovery uses a different helper (`append_pkce_recovery_params`) than regular PKCE (`append_pkce_params`) because recovery appends `/PASSWORD_RECOVERY` suffix to the stored verifier
  - Modules included in the same class can call each other's private methods (e.g., UserMethods calls `append_pkce_params` from SignUpMethods)
  - When assessing story completeness, check ALL methods that send auth requests to see if they need PKCE support, not just the ones mentioned in the story title
---

## 2026-02-10 - US-020
- What was implemented: Comprehensive test suite for the Auth client (157 tests across 8 files covering all acceptance criteria)
- Files changed:
  - `gems/supabase-auth/spec/supabase/auth/client_spec.rb` (new: CF-01 through CF-05, HTTP headers, get_session, get_user tests)
  - `gems/supabase-auth/spec/supabase/auth/sign_up_spec.rb` (new: SU-01 through SU-07, PKCE sign-up, PH-01 through PH-03, AN-01 through AN-03)
  - `gems/supabase-auth/spec/supabase/auth/sign_in_spec.rb` (new: SI-01 through SI-04, OA-01 through OA-05, OT-01 through OT-05, IT-01 through IT-02, SS-01 through SS-02, verify_otp, exchange_code_for_session)
  - `gems/supabase-auth/spec/supabase/auth/session_spec.rb` (new: SM-01 through SM-09, SO-01 through SO-03, UM-01 through UM-04, PR-01 through PR-02, RS-01 through RS-03, reauthenticate)
  - `gems/supabase-auth/spec/supabase/auth/events_spec.rb` (new: EV-01 through EV-06, listener error handling, EVENTS constant)
  - `gems/supabase-auth/spec/supabase/auth/admin_spec.rb` (new: AD-01 through AD-13, admin authentication)
  - `gems/supabase-auth/spec/supabase/auth/mfa_spec.rb` (new: MFA enroll/challenge/verify/unenroll/challenge_and_verify/list_factors/get_authenticator_assurance_level)
  - `gems/supabase-auth/spec/supabase/auth/utilities_spec.rb` (new: JW-01 through JW-03, B6-01 through B6-05, PK-01 through PK-03, SA-01 through SA-03, LK-01 through LK-04, HE-01 through HE-05, error hierarchy, ErrorGuards, Session model)
  - `gems/supabase-auth/lib/supabase/auth/session_helpers.rb` (bugfix: moved EXPIRY_MARGIN_SECONDS constant here)
  - `gems/supabase-auth/lib/supabase/auth/client.rb` (bugfix: removed duplicate EXPIRY_MARGIN_SECONDS constant)
- **Learnings for future iterations:**
  - Constants defined in modules must be scoped to the module where they're used; Ruby constant lookup checks the enclosing module first, NOT the including class
  - `EXPIRY_MARGIN_SECONDS` was in `Client` but used in `SessionHelpers`; Ruby resolved `SessionHelpers::EXPIRY_MARGIN_SECONDS` (not found) instead of `Client::EXPIRY_MARGIN_SECONDS`
  - Auth test JWT helper: `build_jwt(payload)` creates valid 3-part JWTs with configurable payload for testing
  - Session stored via sign_in computes `expires_at` from `expires_in` (future time), not from JWT's `exp` claim; to test expired session loading, store session data directly in storage with past `expires_at`
  - `Lint/EmptyBlock` cop: use `{ |_args| nil }` instead of empty blocks `{ |_args| }` in tests
  - `Style/NumericLiterals` cop: use underscores for large numbers (`9_999_999_999` not `9999999999`)
  - Auth event tests need `sleep(0.1)` to allow async `deliver_initial_session` thread to complete before assertions
  - Split auth tests by concern (8 files) to keep files manageable and organized
---

## 2026-02-10 - US-021
- What was implemented: Realtime Client core connection management with WebSocket support, heartbeat, reconnection with exponential backoff, send buffer, channel management, message routing, and ref counter
- Files changed:
  - `gems/supabase-realtime/lib/supabase/realtime.rb` (updated: added requires for all new modules)
  - `gems/supabase-realtime/lib/supabase/realtime/errors.rb` (new: RealtimeError, RealtimeConnectionError, RealtimeSubscriptionError, RealtimeApiError)
  - `gems/supabase-realtime/lib/supabase/realtime/serializer.rb` (new: JSON encode/decode for Phoenix protocol messages)
  - `gems/supabase-realtime/lib/supabase/realtime/push.rb` (new: Push class for request/reply correlation)
  - `gems/supabase-realtime/lib/supabase/realtime/heartbeat.rb` (new: Heartbeat module with send/handle/start/stop)
  - `gems/supabase-realtime/lib/supabase/realtime/reconnect.rb` (new: Reconnect module with exponential backoff)
  - `gems/supabase-realtime/lib/supabase/realtime/channel_message_handler.rb` (new: ChannelMessageHandler module extracted from RealtimeChannel)
  - `gems/supabase-realtime/lib/supabase/realtime/channel.rb` (new: RealtimeChannel stub for channel lifecycle)
  - `gems/supabase-realtime/lib/supabase/realtime/client.rb` (new: Client class with connect, disconnect, channel, set_auth, push, make_ref)
  - `gems/supabase-realtime/spec/supabase/realtime/client_spec.rb` (new: 58 tests for Client)
  - `gems/supabase-realtime/spec/supabase/realtime/channel_spec.rb` (new: 19 tests for RealtimeChannel)
  - `gems/supabase-realtime/spec/supabase/realtime/serializer_spec.rb` (new: 5 tests for Serializer)
  - `gems/supabase-realtime/spec/supabase/realtime/errors_spec.rb` (new: 7 tests for error hierarchy)
  - `.chief/prds/main/prd.json` (marked US-021 as passes: true)
- **Learnings for future iterations:**
  - WebSocket testing: use `instance_double`, `allow/receive` for WebSocket::Client::Simple; don't require actual connections
  - `Metrics/AbcSize` on `do_connect`: extract `establish_websocket(ws_url)` helper to reduce branch count
  - `Style/TrivialAccessors`: use `attr_reader` instead of trivial getter methods (`def access_token; @access_token; end`)
  - Split Client class: `assign_options` + `init_state` helpers to keep `initialize` under AbcSize limit
  - ChannelMessageHandler module extracted from RealtimeChannel to keep class under ClassLength 100 lines
  - Use frozen constant arrays with `include?` instead of `||` comparisons (`REJOIN_STATES.include?(state)`)
  - Phoenix protocol: heartbeat topic is `"phoenix"`, join/leave events are `"phx_join"` / `"phx_leave"`, replies are `"phx_reply"`
  - HTTP broadcast URL: derived by converting ws->http, stripping /socket/websocket and /realtime/v1, appending /api/broadcast
  - `websocket-client-simple` `connect` block pattern: use `client_ref = self` to capture reference, call private methods via `client_ref.send(:method)`
  - Reconnect module uses `Thread.new` with sleep for delayed reconnection; `reset_reconnect` kills the thread
  - Channel stub provides enough surface for Client to function (subscribe, unsubscribe, rejoin, handle_message, update_access_token); full API in US-022
- Realtime channel API: BroadcastMethods, PresenceMethods, PostgresChangesMethods modules extracted for Channel; Presence class for state management
- HTTP broadcast uses Faraday (added to gemspec); WebSocket broadcast uses existing `client.push`
- Channel join payload includes `config` with `broadcast`, `presence`, and `postgres_changes` bindings
- `ChannelMessageHandler` dispatches: broadcast, presence_diff, presence_state, postgres_changes events
- Reduce `CyclomaticComplexity`: split `handle_message` into `handle_system_event` + `handle_realtime_event`
- Use `SYSTEM_EVENTS` and `REALTIME_EVENTS` frozen constants with `include?` for event categorization
- `on_broadcast(event, &callback)` stores bindings with `type: :broadcast`; dispatched by matching event name
- `on_postgres_changes` normalizes events: `:insert` -> `"INSERT"`, `:all` / `:*` -> `"*"`
- Presence class handles sync/sync_diff with join/leave/sync callbacks; errors in callbacks are swallowed
- HTTP broadcast POST to `client.http_broadcast_url` with apikey + Authorization headers
- Client exposes private `apikey` method for channel HTTP broadcast header construction
---

## 2026-02-10 - US-022
- What was implemented: Realtime Channel API with broadcast, presence, and postgres_changes listeners; enhanced subscribe with bindings config; send_broadcast (WebSocket + HTTP); track/untrack; Presence state management
- Files changed:
  - `gems/supabase-realtime/lib/supabase/realtime.rb` (updated: added requires for new modules)
  - `gems/supabase-realtime/lib/supabase/realtime/channel.rb` (updated: includes BroadcastMethods, PresenceMethods, PostgresChangesMethods; builds join config with bindings; initializes Presence)
  - `gems/supabase-realtime/lib/supabase/realtime/channel_message_handler.rb` (updated: dispatches broadcast, presence_diff, presence_state, postgres_changes events; refactored for complexity)
  - `gems/supabase-realtime/lib/supabase/realtime/client.rb` (updated: added private `apikey` method)
  - `gems/supabase-realtime/lib/supabase/realtime/broadcast_methods.rb` (new: on_broadcast, send_broadcast with :websocket and :http types)
  - `gems/supabase-realtime/lib/supabase/realtime/presence_methods.rb` (new: on_presence with :sync/:join/:leave events, track, untrack)
  - `gems/supabase-realtime/lib/supabase/realtime/postgres_changes_methods.rb` (new: on_postgres_changes with event/schema/table/filter)
  - `gems/supabase-realtime/lib/supabase/realtime/presence.rb` (new: Presence class with state management, sync/sync_diff, join/leave/sync callbacks)
  - `gems/supabase-realtime/supabase-realtime.gemspec` (updated: added faraday ~> 2.0 dependency for HTTP broadcast)
- **Learnings for future iterations:**
  - Realtime gem now depends on both `websocket-client-simple` (WebSocket) AND `faraday` (HTTP broadcast)
  - `Naming/BlockForwarding` cop: use `def method(&)` + `@obj.on_sync(&)` instead of named `&callback`
  - Split `handle_message` into `handle_system_event` + `handle_realtime_event` to satisfy `CyclomaticComplexity` (max 7)
  - `Style/MultipleComparison`: use `[event, WILDCARD].include?(binding[:event])` instead of `||` comparisons
  - Channel bindings stored as array of hashes with `:type` key (:broadcast, :postgres_changes); dispatchers filter by type
  - PostgreSQL change event normalization: `:insert` -> `"INSERT"`, `:update` -> `"UPDATE"`, `:delete` -> `"DELETE"`, `:all`/`:*` -> `"*"`
  - Presence sync_diff applies joins (merge) and leaves (delete) to internal state hash; callbacks receive the diff data
  - HTTP broadcast body format: `{ "messages" => [{ "topic" => ..., "event" => ..., "payload" => ... }] }`
  - Client `remove_channel`, `remove_all_channels`, `get_channels` were already implemented in US-021
---

## 2026-02-10 - US-023
- What was implemented: Comprehensive test suite for the Realtime client (169 total tests across 8 test files covering all acceptance criteria)
- Files changed:
  - `gems/supabase-realtime/spec/supabase/realtime/broadcast_spec.rb` (new: 12 tests for broadcast registration, dispatch, WebSocket/HTTP send, self-broadcast config)
  - `gems/supabase-realtime/spec/supabase/realtime/presence_spec.rb` (new: 29 tests for Presence class sync/sync_diff/callbacks, channel presence integration, track/untrack, presence_diff/presence_state message handling)
  - `gems/supabase-realtime/spec/supabase/realtime/postgres_changes_spec.rb` (new: 26 tests for CDC registration, event normalization, join config, INSERT/UPDATE/DELETE dispatch, schema/table/filter matching, wildcard)
  - `gems/supabase-realtime/spec/supabase/realtime/push_spec.rb` (new: 14 tests for Push initialization, send_message, receive callbacks, trigger, ref correlation)
  - `.chief/prds/main/prd.json` (marked US-023 as passes: true)
- **Test coverage areas:**
  - Connection tests (client_spec.rb): connect, disconnect, reconnect with backoff, state machine
  - Heartbeat tests (client_spec.rb): send at interval, pending ref, reconnect on missed reply, ref matching
  - Channel lifecycle tests (channel_spec.rb): join (phx_join), leave (phx_leave), rejoin after reconnect, state transitions
  - Broadcast tests (broadcast_spec.rb): on_broadcast registration, dispatch to matching/wildcard/multiple listeners, WebSocket send, HTTP fallback with Faraday, apikey/authorization headers, self-broadcast config in join payload
  - Presence tests (presence_spec.rb): Presence class sync/sync_diff, join/leave/sync callbacks, multiple callbacks, error swallowing, channel on_presence integration, track/untrack messages, presence_diff/presence_state message handling
  - PostgreSQL changes tests (postgres_changes_spec.rb): on_postgres_changes with event normalization (:insert->INSERT, :all->*), schema/table/filter bindings, join config payload, INSERT/UPDATE/DELETE/wildcard dispatch, schema/table/event filtering, payload with/without data wrapper
  - Send buffer tests (client_spec.rb): buffer when disconnected, send directly when open, flush on connection
  - Auth token tests (client_spec.rb): set_auth propagates to channels, access_token in join payload
  - Error handling tests (errors_spec.rb, channel_spec.rb): error hierarchy, channel join errors (phx_reply error), server errors (phx_error), phx_close
  - Message routing tests (client_spec.rb): routes by topic, ignores different topics, heartbeat replies to heartbeat handler
  - Ref correlation tests (push_spec.rb): monotonically increasing refs, ref in outgoing message, push/reply matching, late-registered callbacks
- **Learnings for future iterations:**
  - `Style/NilLambda` cop: use `proc { |_p| }` not `proc { |_p| nil }` (empty proc, not explicitly returning nil)
  - `Lint/AmbiguousBlockAssociation`: when chaining `expect(...).to have_requested(...).with { block }`, restructure as `expect(a_request(...).with do...end).to have_been_made`
  - `Style/BlockDelimiters`: use `do...end` not `{...}` for multi-line blocks (even in `.with` chaining)
  - Existing client_spec.rb (58 tests) and channel_spec.rb (19 tests) from US-021/US-022 already covered connection, heartbeat, channel lifecycle, send buffer, auth token, and message routing; US-023 added broadcast, presence, postgres_changes, and push/ref tests
  - WebMock header matching is case-insensitive; `"Apikey"` matches `"apikey"` header
---

## 2026-02-10 - US-024
- What was implemented: Top-level Supabase::Client orchestrator that composes all 5 service clients (Auth, PostgREST, Realtime, Storage, Functions) with shared authentication, URL derivation, validation, delegation, and auth event propagation
- Files changed:
  - `gems/supabase/lib/supabase.rb` (updated: added requires for all new modules + sub-gem requires + `Supabase.create_client` alias)
  - `gems/supabase/lib/supabase/errors.rb` (new: SupabaseError base class, AuthNotAvailableError for third-party auth mode)
  - `gems/supabase/lib/supabase/url_builder.rb` (new: UrlBuilder module with derive_auth_url, derive_rest_url, derive_realtime_url, derive_storage_url, derive_functions_url, derive_storage_key)
  - `gems/supabase/lib/supabase/sub_clients.rb` (new: SubClients module with auth/storage/functions accessors + init helpers for all 5 sub-clients)
  - `gems/supabase/lib/supabase/delegation.rb` (new: Delegation module with from/schema/rpc -> PostgREST, channel/get_channels/remove_channel/remove_all_channels -> Realtime)
  - `gems/supabase/lib/supabase/auth_token_manager.rb` (new: AuthTokenManager module with token resolution, auth event propagation, third-party auth setup)
  - `gems/supabase/lib/supabase/client.rb` (new: Client class with constructor, URL/key validation, URL derivation, header configuration, sub-client initialization)
  - `.chief/prds/main/prd.json` (marked US-024 as passes: true)
- **Implementation details:**
  - Client split into 5 modules + main class to stay under ClassLength 100: UrlBuilder, SubClients, Delegation, AuthTokenManager, Client
  - URL validation: rejects nil/empty, non-HTTP(S), and malformed URIs
  - API key validation: rejects nil/empty
  - URL derivation: /auth/v1, /rest/v1, wss://.../realtime/v1, /storage/v1, /functions/v1
  - Storage key: `sb-{hostname_first_part}-auth-token`
  - Headers: apikey, Authorization: Bearer {key}, X-Client-Info: supabase-rb/{version}
  - Session-based mode: full Auth client + auth event listener for Realtime token sync
  - Third-party auth mode (access_token callback): auth accessor raises AuthNotAvailableError; Realtime gets token via set_auth
  - Auth event propagation: signed_in/token_refreshed -> realtime.set_auth(token) with dedup; signed_out -> realtime.set_auth(nil)
  - functions accessor creates new FunctionsClient on each access (latest headers with current token)
  - Deep config merge: user options > computed defaults > static defaults
  - `Supabase.create_client(url, key, **opts)` module-level factory alias
- **Learnings for future iterations:**
  - Top-level gem requires all 5 sub-gems via `require "supabase/{name}"` (not `require_relative`)
  - Store `@base_url` for reuse in storage key derivation (don't derive from sub-URLs)
  - `Style/IfUnlessModifier` conflicts with `Layout/LineLength` when the modifier form exceeds 120 chars; use multi-line `if` block instead
  - Realtime client constructor takes positional `url` arg (not keyword), unlike other clients which use `url:` keyword
  - Auth client `on_auth_state_change` fires `:initial_session` asynchronously; token propagation must handle this
  - `Hash#except` (Ruby 3.0+) is useful for passing options while excluding specific keys (e.g., `:params` from realtime_opts)
---

## 2026-02-10 - US-025
- What was implemented: Comprehensive test suite for the top-level Supabase client (64 tests covering all acceptance criteria)
- Files changed:
  - `gems/supabase/spec/supabase/client_spec.rb` (new: 64 tests covering CV, UC, SK, AM, FW, TP, SD, CD categories + error hierarchy, factory, token resolution, realtime config, URL port handling)
  - `.chief/prds/main/prd.json` (marked US-025 as passes: true)
- **Test coverage areas:**
  - Constructor validation (CV-01 through CV-10): nil/empty/whitespace URL and key, non-HTTP URL, malformed URL, valid HTTP/HTTPS
  - URL construction (UC-01 through UC-03): auth/rest/storage/functions URL derivation, Realtime wss/ws scheme conversion
  - Storage key derivation (SK-01 through SK-03): hostname extraction (supabase.co, localhost, IP address)
  - Auth mode tests (AM-01 through AM-05): session-based mode (auth client + event listener), third-party mode (no auth client, raises AuthNotAvailableError, sets initial realtime token)
  - Auth-wrapped fetch (FW-01 through FW-06): apikey header, Authorization Bearer, X-Client-Info, global header merge, user override, functions accessor
  - Token propagation (TP-01 through TP-06): signed_in, token_refreshed, signed_out, deduplication, irrelevant events, multi-step flow
  - Sub-client delegation (SD-01 through SD-10): from/schema/rpc -> PostgREST, channel/get_channels/remove_channel/remove_all_channels -> Realtime, auth/storage/functions accessors
  - Configuration defaults (CD-01 through CD-08): realtime apikey, db schema, auth defaults, auth override merge, realtime params merge, custom fetch, trailing slash
  - X-Client-Info header, error hierarchy (SupabaseError, AuthNotAvailableError), Supabase.create_client factory, token resolution (callback, session, fallback), realtime config passthrough, URL port handling
- **Learnings for future iterations:**
  - Mock all 5 sub-clients with `instance_double` + `allow/receive` to prevent real initialization; Realtime needs `set_auth` stub, Auth needs `on_auth_state_change` and `get_session` stubs
  - Token deduplication: `@last_realtime_token` starts as nil, so a nil token from signed_in event gets deduplicated (no propagation); only non-nil tokens or signed_out reset change the state
  - `Lint/UselessAssignment`: don't assign `client = described_class.new(...)` when only verifying constructor side effects via `have_received`
  - `Layout/FirstHashElementIndentation`: when passing multiline hash in method args, use `described_class.new(\n  url, key, realtime: {\n    ...` pattern
---

## 2026-02-10 - US-026
- What was implemented: Documentation and examples - root README, per-gem READMEs, and YARD documentation on all public methods
- Files created:
  - `README.md` (new: root README with overview, installation, quick start, API overview, error handling, configuration, requirements)
  - `gems/supabase-auth/README.md` (new: Auth gem README with sign-up/sign-in, session management, MFA, Admin, PKCE, error hierarchy)
  - `gems/supabase-postgrest/README.md` (new: PostgREST gem README with CRUD, filters, transforms, result format)
  - `gems/supabase-realtime/README.md` (new: Realtime gem README with broadcast, presence, CDC, connection lifecycle)
  - `gems/supabase-storage/README.md` (new: Storage gem README with bucket management, file operations, URL operations, image transforms)
  - `gems/supabase-functions/README.md` (new: Functions gem README with invoke, body auto-detection, response parsing, error hierarchy)
- Files modified (YARD documentation added):
  - `gems/supabase/lib/supabase/client.rb` (YARD on initialize with @param, @option)
  - `gems/supabase/lib/supabase/sub_clients.rb` (YARD on auth, storage, functions with @return, @raise)
  - `gems/supabase/lib/supabase/delegation.rb` (YARD on from, schema, rpc, channel, get_channels, remove_channel, remove_all_channels)
  - `gems/supabase-auth/lib/supabase/auth/client.rb` (YARD on initialize with @option)
  - `gems/supabase-auth/lib/supabase/auth/sign_up_methods.rb` (YARD on sign_up, sign_in_anonymously)
  - `gems/supabase-auth/lib/supabase/auth/sign_in_methods.rb` (YARD on sign_in_with_password, sign_in_with_oauth, sign_in_with_otp, sign_in_with_id_token, sign_in_with_sso)
  - `gems/supabase-auth/lib/supabase/auth/verify_methods.rb` (YARD on verify_otp, exchange_code_for_session)
  - `gems/supabase-auth/lib/supabase/auth/session_methods.rb` (YARD on set_session, refresh_session, sign_out)
  - `gems/supabase-auth/lib/supabase/auth/user_methods.rb` (YARD on update_user, reset_password_for_email, reauthenticate, resend)
  - `gems/supabase-auth/lib/supabase/auth/auth_state_events.rb` (YARD on on_auth_state_change with @yield/@yieldparam)
  - `gems/supabase-storage/lib/supabase/storage/client.rb` (YARD on initialize, from)
  - `gems/supabase-storage/lib/supabase/storage/storage_file_api.rb` (YARD on initialize)
  - `gems/supabase-storage/lib/supabase/storage/bucket_api.rb` (YARD on all 6 bucket methods)
  - `gems/supabase-storage/lib/supabase/storage/file_operations.rb` (YARD on upload, update, download, move, copy, remove, info, exists?)
  - `gems/supabase-storage/lib/supabase/storage/url_operations.rb` (YARD on create_signed_url, create_signed_urls, create_signed_upload_url, upload_to_signed_url, get_public_url, list)
  - `gems/supabase-realtime/lib/supabase/realtime/client.rb` (YARD on initialize, connect, disconnect, channel, set_auth, remove_channel, remove_all_channels, get_channels, make_ref, push, log)
  - `gems/supabase-realtime/lib/supabase/realtime/channel.rb` (YARD on initialize, subscribe, unsubscribe, rejoin, update_access_token)
  - `gems/supabase-realtime/lib/supabase/realtime/broadcast_methods.rb` (YARD on on_broadcast, send_broadcast)
  - `gems/supabase-realtime/lib/supabase/realtime/presence_methods.rb` (YARD on on_presence, track, untrack)
  - `gems/supabase-realtime/lib/supabase/realtime/postgres_changes_methods.rb` (YARD on on_postgres_changes)
- **Learnings for future iterations:**
  - YARD `@return` tags with long type signatures (e.g., `Hash{Symbol => Hash, nil}`) easily exceed 120 char line limit; use short descriptions like "result with data and error keys"
  - YARD `@yieldparam` with long enum lists must be wrapped across multiple lines
  - Background agents (Task tool) work well for parallelizing YARD doc additions across multiple gems
  - Edit tool requires reading a file first in the same session context; delegating to agents avoids this limitation
---
