## Codebase Patterns
- Use `eval "$(rbenv init -)"` before running Ruby commands to ensure Ruby 3.3.0 is active (system Ruby is 2.6)
- Root Rakefile runs all gem specs via `bundle exec rake spec` with `-I gems/{name}/spec -I gems/{name}/lib` for proper load paths
- Each gem follows pattern: `gems/{name}/lib/supabase/{module}.rb` requires `{module}/version`
- VERSION constant lives at `Supabase::{Module}::VERSION` (top-level gem uses `Supabase::VERSION`)
- Gemspecs are excluded from rubocop via `**/*.gemspec` in `.rubocop.yml`
- HTTP gems depend on `faraday ~> 2.0`, WebSocket gem depends on `websocket-client-simple ~> 0.8`
- No cross-gem runtime dependencies (except top-level `supabase` gem which depends on all 5)
- All specs use webmock for HTTP stubbing
- `.rspec` files in each gem directory with `--require spec_helper`
- Rubocop ClassLength limit is 100 lines; extract modules to keep classes small
- Use `**options` keyword splat for methods with >5 params to satisfy `Metrics/ParameterLists`
- All client methods return `{ data:, error: }` result hashes (never raise by default)
- Error hierarchy pattern: BaseError < StandardError, then specific subclasses with `status:` and `context:` attrs
- Test files go in `gems/{name}/spec/supabase/{module}/` subdirectories (e.g., `client_spec.rb`)
- WebMock: do NOT chain multiple `.to_return` on same stub (they cycle sequentially); use one `stub_request(...).to_return(...)` per test
- Rubocop `Naming/VariableNumber`: use normalcase for symbol numbers (`:ap_southeast1` not `:ap_southeast_1`)
- Faraday test adapter blocks must be multiline `do...end`, not single-line, to satisfy `Style/BlockDelimiters`
- PostgREST result hash: `{ data:, error:, count:, status:, status_text: }` (extends standard `{ data:, error: }` pattern)
- PostgREST Builder uses `**options` splat in `initialize(url:, **options)` to stay under 5 param limit
- Extract ResponseHandler module from Builder to stay under ClassLength 100 lines
- `Naming/MethodParameterName` requires 3+ chars; use `function_name` not `fn`
- `Lint/DuplicateBranch`: avoid `elsif` and `else` branches with same body; merge them
- CRUD methods return FilterBuilder (not QueryBuilder); QueryBuilder is the entry point, FilterBuilder chains further
- CrudBuilder module extracted from QueryBuilder to keep classes under 100 lines; pattern: extract `{Thing}Builder` module
- `Lint/UnusedBlockArgument`: prefix unused block args with `_` (e.g., `|_url, headers|`)
- FilterBuilder#select adds `Prefer: return=representation` for mutation results
- Bulk insert: `columns` param set from union of all Hash keys in array
- Filter methods mutate `@url` in-place and return `self` for chaining; use modules (Filters, RangeFilters) to split methods
- `Naming/PredicatePrefix` cop: use `rubocop:disable` inline for API-convention `is_*` methods that aren't predicates
- Transform methods (order, limit, range, single, csv, etc.) live in Transforms module included by FilterBuilder
- `Metrics/AbcSize`/`CyclomaticComplexity`: split methods with many boolean flags into helper + collector pattern
- `maybe_single` requires FilterBuilder#execute override for post-processing (unwrap array, synthesize PGRST116 error)
- Filter patterns with `%` (like/ilike) cause URI::InvalidURIError; test via `builder.url.query` instead of `stub_request` for those
- Text search queries with spaces get URL-encoded to `%20` by URI.parse; account for encoding in assertions
- Use `%r{}` instead of `//` for regexes containing slashes (Style/RegexpLiteral cop)
- Split large test suites into multiple files by concern (client, crud, filters, transforms, errors) for manageability
- `Style/KeywordParametersOrder`: required kwargs must come before optional kwargs in method signatures
- Storage API pattern: BucketApi module extracted from Client, StorageFileApi returned by `from(bucket_id)`
- Storage API endpoints: `/bucket` (list), `/bucket/{id}` (get/update/delete), `/bucket/{id}/empty` (empty)
- Storage file endpoints: `/object/{bucket}/{path}` (upload/update/download/exists), `/object/move`, `/object/copy`, `/object/info/{bucket}/{path}`
- StorageFileApi has independent HTTP helpers (not shared with Client); each class handles its own Faraday connections
- Storage upload headers use lowercase keys: `cache-control`, `content-type`, `x-upsert`, `x-metadata`
- Storage move/copy use camelCase JSON body keys: `bucketId`, `sourceKey`, `destinationBucket`, `destinationKey`
- Storage URL operations: signed URLs from `/object/sign/`, public URLs from `/object/public/`, image transforms from `/render/image/public/` or `/render/image/authenticated/`
- Storage list endpoint: POST to `/object/list/{bucket}` with body `{ prefix:, limit:, offset:, sortBy:, search: }`
- `get_public_url` is pure URL construction (no HTTP); all other URL methods make HTTP calls
- `Style/IfUnlessModifier`: use modifier form for single-line if bodies (e.g., `result[:key] = value if condition`)
- Auth error hierarchy: AuthError (base), AuthApiError, AuthRetryableFetchError, AuthUnknownError, AuthSessionMissingError, AuthInvalidTokenResponseError, AuthInvalidCredentialsError, AuthWeakPasswordError, AuthPKCEGrantCodeExchangeError
- Auth error classification: 502/503/504 -> AuthRetryableFetchError, 4xx+JSON -> AuthApiError, 4xx+non-JSON -> AuthUnknownError, Faraday::Error -> AuthRetryableFetchError(status: 0), weak_password code -> AuthWeakPasswordError
- Auth HTTP layer sends `X-Supabase-Api-Version: 2024-01-01` and `X-Client-Info: supabase-rb/{VERSION}` on all requests
- `Naming/AccessorMethodName` cop flags `get_*` methods; disable inline for API-convention names (`get_session`, `get_user`)
- `Naming/BlockForwarding` cop: use `&` anonymous forwarding (`def method(&)`) instead of named `&block` when just yielding
- `Lint/AmbiguousOperatorPrecedence`: wrap mixed `+` and `*` expressions with parentheses
- `Style/MutableConstant`: freeze interpolated string constants (`"supabase-rb/#{VERSION}".freeze`)
- Auth Client uses ErrorClassifier module to classify HTTP responses into error types, and HttpHandler module for HTTP layer
- Auth Session model computes `expires_at` from `expires_in` if not explicitly provided
- Auth sign-in/sign-up split into 3 modules: SignUpMethods, SignInMethods, VerifyMethods (included by Client)
- PKCE module uses `module_function` for stateless utility methods; verifier stored under `{storage_key}-code-verifier`
- Auth `handle_session_response` saves session + emits `:signed_in`; `handle_sign_up_response` distinguishes session vs confirmation
- OAuth `sign_in_with_oauth` builds URL synchronously (no HTTP); all other sign-in methods make HTTP calls
- Code verifier with `/PASSWORD_RECOVERY` suffix triggers `:password_recovery` event in `exchange_code_for_session`

---

## 2026-02-10 - US-001
- What was implemented: Multi-gem monorepo scaffolding with 6 gems (supabase, supabase-auth, supabase-postgrest, supabase-realtime, supabase-storage, supabase-functions)
- Files changed:
  - Root: Gemfile, Gemfile.lock, Rakefile, .rubocop.yml, .rspec, .ruby-version, .gitignore
  - Per gem (x6): gemspec, Gemfile, .rspec, lib/{module}.rb, lib/{module}/version.rb, spec/spec_helper.rb, spec/{module}_spec.rb
- **Learnings for future iterations:**
  - System Ruby is 2.6; must use rbenv with `eval "$(rbenv init -)"` to get Ruby 3.3.0
  - Root `*.gemspec` glob only matches root-level gemspecs; use `**/*.gemspec` to exclude nested ones
  - Running rspec from root requires explicit `-I` flags for each gem's spec and lib dirs
  - Bundler resolves all 6 gemspecs from the root Gemfile via `gemspec path:` directives
---

## 2026-02-10 - US-002
- What was implemented: Functions Client core with error hierarchy, body auto-serialization, response parsing, region routing, header precedence, and all HTTP methods
- Files changed:
  - `gems/supabase-functions/lib/supabase/functions.rb` (added requires for errors, client)
  - `gems/supabase-functions/lib/supabase/functions/errors.rb` (new: FunctionsError, FunctionsFetchError, FunctionsRelayError, FunctionsHttpError)
  - `gems/supabase-functions/lib/supabase/functions/client.rb` (new: Client class with invoke, set_auth, body/response handling)
  - `gems/supabase-functions/lib/supabase/functions/response_handler.rb` (new: extracted response processing module)
  - `.chief/prds/main/prd.json` (marked US-002 as passes: true)
- **Learnings for future iterations:**
  - Rubocop ClassLength limit is 100 lines; extract modules (e.g., ResponseHandler) to keep classes under limit
  - `Naming/AccessorMethodName` cop flags `set_*` methods; use `rubocop:disable` inline when matching external API conventions (e.g., Supabase JS client's `set_auth`)
  - `invoke` uses `**options` keyword splat instead of 6 positional params to avoid `Metrics/ParameterLists` cop
  - Rescue specific exceptions (`Faraday::Error, IOError`) instead of broad `StandardError` to avoid `Lint/DuplicateBranch`
  - Response handler: `text/event-stream` returns raw Faraday response object (not body) per Supabase spec
---

## 2026-02-10 - US-003
- What was implemented: Comprehensive test suite for the Functions client (64 tests total)
- Files changed:
  - `gems/supabase-functions/spec/supabase/functions/client_spec.rb` (new: 64 tests covering all acceptance criteria)
  - `.chief/prds/main/prd.json` (marked US-003 as passes: true)
- **Test coverage areas:**
  - AU-01 through AU-05: Authentication / set_auth persistence
  - BH-01 through BH-08: Body auto-detection and serialization (String, Hash, Array, IO, StringIO, nil, nested, empty)
  - RP-01 through RP-08: Response parsing (JSON, JSON array, text/plain, octet-stream, event-stream, charset, unknown, missing)
  - EH-01 through EH-08: Error handling (HttpError, RelayError, FetchError, network, timeout, context)
  - RR-01 through RR-05: Region routing (default :any, client-level, invoke-level override, :any override, symbol conversion)
  - TC-01 through TC-05: Timeout behavior (default, per-request, expiry, custom fetch with/without timeout)
  - HP-01 through HP-03: Header precedence (invoke > client > auto-detected)
  - HM-01 through HM-05: HTTP methods (POST, GET, PUT, PATCH, DELETE)
  - Error hierarchy tests, constructor tests, invalid method test, 5 integration scenarios
- **Learnings for future iterations:**
  - WebMock `.to_return` calls are additive (cycle through responses); never chain a helper that calls `.to_return` with another `.to_return`
  - Use direct `stub_request(:method, url).to_return(...)` in each test for clarity; avoid helpers with default responses
  - Rubocop `Naming/VariableNumber` applies to symbols too: `:ap_southeast1` not `:ap_southeast_1`
  - Faraday test adapter: use multiline `do...end` blocks to satisfy `Style/BlockDelimiters` and `Style/SingleLineDoEndBlock`
---

## 2026-02-10 - US-004
- What was implemented: PostgREST Client core builder infrastructure with error hierarchy, builder base class, query builder, response handler, and client with from/schema/rpc
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (added requires for errors, builder, query_builder, client)
  - `gems/supabase-postgrest/lib/supabase/postgrest/errors.rb` (new: PostgrestError with message, details, hint, code)
  - `gems/supabase-postgrest/lib/supabase/postgrest/response_handler.rb` (new: extracted response parsing, error handling, count parsing)
  - `gems/supabase-postgrest/lib/supabase/postgrest/builder.rb` (new: base Builder class with execute, schema headers, throw_on_error, dup_with)
  - `gems/supabase-postgrest/lib/supabase/postgrest/query_builder.rb` (new: QueryBuilder < Builder scoped to table)
  - `gems/supabase-postgrest/lib/supabase/postgrest/client.rb` (new: Client with from(), schema(), rpc())
  - `.chief/prds/main/prd.json` (marked US-004 as passes: true)
- **Learnings for future iterations:**
  - Builder uses `initialize(url:, **options)` pattern to keep params under 5; QueryBuilder passes options through via `super(url:, **options)`
  - ResponseHandler module extracted from Builder to keep class under 100 lines; includes build_result, parse_error, parse_data, parse_count, handle_fetch_error
  - PostgREST result hash adds count, status, status_text beyond the standard { data:, error: } pattern
  - `Naming/MethodParameterName` cop requires 3+ character param names; renamed `fn` to `function_name`
  - `Lint/DuplicateBranch`: text/csv and else both returned response.body, merged into single else branch
  - Builder#dup_with is the immutability mechanism: dups URL and headers to ensure independence
  - Schema headers: Accept-Profile for GET/HEAD, Content-Profile for POST/PATCH/DELETE
---

## 2026-02-10 - US-005
- What was implemented: PostgREST CRUD operations (select, insert, update, upsert, delete) with FilterBuilder for mutation chaining
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest/crud_builder.rb` (new: CrudBuilder module with select, insert, update, upsert, delete methods)
  - `gems/supabase-postgrest/lib/supabase/postgrest/filter_builder.rb` (new: FilterBuilder < Builder with .select for return=representation)
  - `gems/supabase-postgrest/lib/supabase/postgrest/query_builder.rb` (updated: includes CrudBuilder module)
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (updated: added requires for filter_builder and crud_builder)
  - `.chief/prds/main/prd.json` (marked US-005 as passes: true)
- **Implementation details:**
  - QueryBuilder includes CrudBuilder module with select, insert, update, upsert, delete
  - Each CRUD method returns a FilterBuilder (for chaining filters/transforms in US-006/US-007)
  - FilterBuilder#select adds `Prefer: return=representation` and `?select=` for mutation results
  - Bulk insert (Array of Hashes) auto-sets `columns` query param from union of all Hash keys
  - Upsert sets `Prefer: resolution=merge-duplicates` (default) or `resolution=ignore-duplicates`
  - `default_to_null: false` adds `Prefer: missing=default`
  - `on_conflict` sets the `on_conflict` query param for upserts
  - `count` option adds `Prefer: count={algorithm}` header for all operations
  - `head: true` on select uses HEAD method
- **Learnings for future iterations:**
  - Extract CRUD methods into CrudBuilder module to keep QueryBuilder small (rubocop ClassLength)
  - FilterBuilder extends Builder so it inherits execute/schema headers/throw_on_error
  - Use `_url` prefix for unused block args to satisfy `Lint/UnusedBlockArgument`
  - `dup_with` pattern from Builder reused in FilterBuilder for immutable .select chaining
---

## 2026-02-10 - US-006
- What was implemented: PostgREST Filter Builder with all comparison, pattern, regex, collection, range, text search, and compound filter methods
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest/filters.rb` (new: Filters module with eq, neq, gt, gte, lt, lte, is, is_distinct, like, ilike, like_all_of, like_any_of, ilike_all_of, ilike_any_of, match, imatch, in, contains, contained_by, overlaps)
  - `gems/supabase-postgrest/lib/supabase/postgrest/range_filters.rb` (new: RangeFilters module with range_gt, range_gte, range_lt, range_lte, range_adjacent, text_search, match_filter, not, or, filter)
  - `gems/supabase-postgrest/lib/supabase/postgrest/filter_builder.rb` (updated: includes Filters and RangeFilters modules, added private helpers append_filter, quote_filter_value, format_containment)
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (updated: added requires for filters and range_filters)
  - `.chief/prds/main/prd.json` (marked US-006 as passes: true)
- **Learnings for future iterations:**
  - `Naming/PredicatePrefix` cop flags `is_*` methods as predicates; use `rubocop:disable` inline for PostgREST API-convention method names like `is_distinct`
  - Filter methods mutate `@url` in-place and return `self` for chaining (not immutable like `select`)
  - Extract filter methods into multiple modules (Filters, RangeFilters) to stay under ClassLength 100 limit
  - `in` filter: values with reserved chars (comma, parens, quotes) must be quoted with escaped double quotes
  - `contains`/`contained_by`/`overlaps`: Array becomes `{a,b}`, Hash becomes JSON-serialized string
  - `or` filter uses `key=(filters)` format; with `referenced_table`, key becomes `table.or`
  - `match_filter` applies multiple `eq` filters from a Hash
  - `text_search` operator mapping: nil->fts, :plain->plfts, :phrase->phfts, :websearch->wfts; config appended as `op(config)`
---

## 2026-02-10 - US-007
- What was implemented: PostgREST Transform Builder with order, limit, range, single, maybe_single, csv, geojson, explain, rollback, and max_affected methods
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest/transforms.rb` (new: Transforms module with all transform methods)
  - `gems/supabase-postgrest/lib/supabase/postgrest/filter_builder.rb` (updated: includes Transforms module, added execute override for maybe_single, added handle_maybe_single)
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (updated: added require for transforms)
  - `.chief/prds/main/prd.json` (marked US-007 as passes: true)
- **Implementation details:**
  - Transforms module extracted to keep FilterBuilder under 100 lines (same pattern as Filters/RangeFilters)
  - `order` supports multiple calls by appending to existing order param (comma-separated)
  - `range(from, to)` converts to offset + limit params (0-based inclusive: limit = to - from + 1)
  - `single` sets Accept: application/vnd.pgrst.object+json; PostgREST errors on != 1 row
  - `maybe_single` sets same Accept header + @maybe_single flag; execute override unwraps arrays and synthesizes PGRST116 error on >1 row
  - `explain` builds Accept header with `for="explain"` prefix and pipe-separated options
  - `rollback` and `max_affected` append to Prefer header
  - Transform methods mutate `@headers`/`@url` in-place and return `self` for chaining (same as filter methods)
- **Learnings for future iterations:**
  - `Metrics/AbcSize` and `CyclomaticComplexity`: split methods with many boolean flags into helper + collector (e.g., `build_explain_header` + `collect_explain_parts`)
  - `Lint/DuplicateBranch`: remove redundant if/else with same body (e.g., maybe_single had identical branches for GET vs non-GET)
  - `order` appending: use regex gsub on existing query string to append comma-separated values to existing `order=` param
  - `maybe_single` needs FilterBuilder#execute override (not Builder) since it's post-processing logic specific to the result
---

## 2026-02-10 - US-008
- What was implemented: Comprehensive test suite for the PostgREST client (127 tests total across 4 test files)
- Files changed:
  - `gems/supabase-postgrest/spec/supabase/postgrest/client_spec.rb` (new: CI-01 through CI-06, from/schema/RPC tests, SC-01 through SC-04, RP-01 through RP-07)
  - `gems/supabase-postgrest/spec/supabase/postgrest/crud_spec.rb` (new: SE-01 through SE-07, IN-01 through IN-05, UP-01 through UP-02, US-01 through US-03, DE-01 through DE-03)
  - `gems/supabase-postgrest/spec/supabase/postgrest/filters_spec.rb` (new: FI-01 through FI-25, range filters, text search, compound filters)
  - `gems/supabase-postgrest/spec/supabase/postgrest/transforms_spec.rb` (new: TR-01 through TR-17, explain, rollback, max_affected)
  - `gems/supabase-postgrest/spec/supabase/postgrest/errors_spec.rb` (new: EH-01 through EH-08, BI-01 through BI-03, response parsing, custom fetch, error hierarchy)
  - `.chief/prds/main/prd.json` (marked US-008 as passes: true)
- **Test coverage areas:**
  - Client initialization (CI-01 through CI-06)
  - SELECT operations (SE-01 through SE-07)
  - INSERT operations (IN-01 through IN-05)
  - UPDATE operations (UP-01 through UP-02)
  - UPSERT operations (US-01 through US-03)
  - DELETE operations (DE-01 through DE-03)
  - All filters (FI-01 through FI-25): eq, neq, gt, gte, lt, lte, is, is_distinct, like, ilike, like_all_of, like_any_of, ilike_all_of, ilike_any_of, match, imatch, in, contains, contained_by, overlaps, chaining
  - Range filters: range_gt, range_gte, range_lt, range_lte, range_adjacent
  - Text search: fts, plfts, phfts, wfts with config
  - Compound filters: match_filter, not, or, filter
  - All transforms (TR-01 through TR-17): order, limit, range, single, maybe_single, csv, geojson, explain, rollback, max_affected
  - RPC (RP-01 through RP-07): POST/GET/HEAD, count, schema
  - Error handling (EH-01 through EH-08): JSON errors, non-JSON errors, network errors, timeout, throw_on_error
  - Schema switching (SC-01 through SC-04): Accept-Profile, Content-Profile
  - Builder immutability (BI-01 through BI-03): from() independence, throw_on_error copies, select copies
  - Response parsing: JSON, vnd.pgrst, CSV, Content-Range count
  - URL construction validation across all test categories
- **Learnings for future iterations:**
  - Split tests into multiple files (client, crud, filters, transforms, errors) to keep files manageable
  - Patterns with `%` chars in like/ilike filter tests cause URI::InvalidURIError when used via `append_query_param` with URI.parse; test query string assertions instead of HTTP stubs for those patterns
  - Text search queries with spaces get URL-encoded by URI.parse; match against `%20` in query string assertions
  - Use `%r{}` instead of `//` for regexes with slashes (Style/RegexpLiteral cop)
  - Unused variable assignments in tests trigger `Lint/UselessAssignment`; omit the assignment if the return value isn't checked
---

## 2026-02-10 - US-009
- What was implemented: Storage Client core with error hierarchy, bucket management API, and StorageFileApi stub
- Files changed:
  - `gems/supabase-storage/lib/supabase/storage.rb` (updated: added requires for errors and client)
  - `gems/supabase-storage/lib/supabase/storage/errors.rb` (new: StorageError, StorageApiError, StorageUnknownError)
  - `gems/supabase-storage/lib/supabase/storage/client.rb` (new: Client with from(), bucket management delegation, HTTP helpers)
  - `gems/supabase-storage/lib/supabase/storage/bucket_api.rb` (new: BucketApi module with list_buckets, get_bucket, create_bucket, update_bucket, empty_bucket, delete_bucket)
  - `gems/supabase-storage/lib/supabase/storage/storage_file_api.rb` (new: StorageFileApi stub class for file operations)
  - `.chief/prds/main/prd.json` (marked US-009 as passes: true)
- **Implementation details:**
  - Error hierarchy follows same pattern as Functions: base StorageError < StandardError with `context:`, subclasses add `status:`
  - StorageApiError for HTTP errors (non-2xx), StorageUnknownError for network/Faraday failures
  - BucketApi module extracted from Client to keep classes under 100 lines (ClassLength cop)
  - Client delegates bucket methods via `include BucketApi`; `from(bucket_id)` returns a StorageFileApi scoped to the bucket
  - All bucket methods return `{ data:, error: }` pattern; rescue Faraday::Error for network failures
  - JSON responses auto-parsed; error messages extracted from JSON `message` or `error` keys
  - StorageFileApi is a stub with `initialize(url:, bucket_id:, headers: {}, fetch: nil)` ready for US-010/US-011
- **Learnings for future iterations:**
  - `Style/KeywordParametersOrder`: required kwargs must come before optional kwargs (e.g., `bucket_id:` before `headers: {}`)
  - Storage API endpoints: `/bucket` for list, `/bucket/{id}` for get/update/delete, `/bucket/{id}/empty` for empty
  - `create_bucket` sends both `id` and `name` fields (both set to the bucket_id)
  - `update_bucket` requires `public:` field in the body
  - Running specs from root requires `bundle exec rake supabase_storage:spec` (not direct `rspec` which lacks `-I` flags)
---

## 2026-02-10 - US-010
- What was implemented: Storage Client file operations (upload, update, download, move, copy, remove, info, exists?) with path normalization
- Files changed:
  - `gems/supabase-storage/lib/supabase/storage/file_operations.rb` (new: FileOperations module with upload, update, download, move, copy, remove, info, exists?)
  - `gems/supabase-storage/lib/supabase/storage/storage_file_api.rb` (updated: includes FileOperations, added private helpers for path normalization, upload headers, body reading, download URLs, HTTP, response handling)
  - `.chief/prds/main/prd.json` (marked US-010 as passes: true)
- **Implementation details:**
  - FileOperations module extracted from StorageFileApi to keep class under 100 lines
  - `upload` sends POST to `/object/{bucket}/{path}` with cache-control, content-type, x-upsert, x-metadata headers
  - `update` sends PUT to same endpoint (replaces file)
  - `download` sends GET to `/object/{bucket}/{path}`; with transform uses `/render/image/authenticated/{bucket}/{path}?{params}`
  - `move` sends POST to `/object/move` with bucketId, sourceKey, destinationBucket, destinationKey
  - `copy` sends POST to `/object/copy` with same body structure
  - `remove` sends DELETE to `/object/{bucket}` with `{ prefixes: paths }` body
  - `info` sends GET to `/object/info/{bucket}/{path}`
  - `exists?` sends HEAD to `/object/{bucket}/{path}`, returns boolean based on status
  - Path normalization: strips leading/trailing slashes, collapses consecutive slashes
  - Body reading: IO/StringIO read via `.read`, String via `.to_s`
  - Default content-type is `application/octet-stream`
- **Learnings for future iterations:**
  - StorageFileApi has its own HTTP helpers (perform_request, build_connection, handle_response) independent of Client
  - FileOperations module pattern follows same extraction as BucketApi, Filters, RangeFilters, Transforms, CrudBuilder
  - Upload headers use lowercase keys (`cache-control`, `content-type`, `x-upsert`, `x-metadata`) per Supabase convention
  - `move` and `copy` use camelCase keys in JSON body (bucketId, sourceKey, etc.) to match Supabase API
  - `exists?` uses HEAD method and checks status range; returns `{ data: true/false, error: nil }`
  - `download` returns raw binary body (not JSON-parsed) in `{ data: body, error: nil }`
---

## 2026-02-10 - US-011
- What was implemented: Storage Client URL operations and file listing (create_signed_url, create_signed_urls, create_signed_upload_url, upload_to_signed_url, get_public_url, list) with image transform support
- Files changed:
  - `gems/supabase-storage/lib/supabase/storage/url_operations.rb` (new: UrlOperations module with all URL and listing methods)
  - `gems/supabase-storage/lib/supabase/storage/storage_file_api.rb` (updated: includes UrlOperations module)
  - `.chief/prds/main/prd.json` (marked US-011 as passes: true)
- **Implementation details:**
  - `create_signed_url` sends POST to `/object/sign/{bucket}/{path}` with expiresIn and optional transform; returns full signed URL
  - `create_signed_urls` sends POST to `/object/sign` (batch) with paths prefixed by bucket_id
  - `create_signed_upload_url` sends POST to `/object/upload/sign/{bucket}/{path}` with optional x-upsert header; returns signed_url + token + path
  - `upload_to_signed_url` sends PUT to `/object/upload/sign/{bucket}/{path}?token=` with upload headers
  - `get_public_url` is synchronous (no HTTP call); uses `/render/image/public/` for transforms, `/object/public/` otherwise
  - `list` sends POST to `/object/list/{bucket}` with prefix, limit, offset, sortBy, search body
  - Image transform params (width, height, resize, quality, format) appended as query params
  - Download param: `download=` (boolean true) or `download={filename}` (string); URI-encoded
  - Signed URL download param uses separator logic (? vs &) since signed URLs already have query params
- **Learnings for future iterations:**
  - UrlOperations module follows same extraction pattern as FileOperations, BucketApi, Filters, etc.
  - Module was initially 104 lines (over 100 limit); compacted by inlining small helpers and removing intermediate variables
  - `Style/IfUnlessModifier` cop: single-line if bodies should use modifier form (`result[:key] = value if condition`)
  - Signed URL API returns `signedURL` (camelCase) in response JSON
  - Batch signed URLs endpoint is `/object/sign` (no bucket/path in URL); paths are passed in body with bucket prefix
  - Signed upload URL response has `url` field as relative path; must be prepended with base URL
  - `get_public_url` never makes HTTP calls - it's pure URL construction
  - `list` uses `sortBy` (camelCase) in request body to match Supabase API convention
---

## 2026-02-10 - US-012
- What was implemented: Comprehensive test suite for the Storage client (91 tests across 5 test files)
- Files changed:
  - `gems/supabase-storage/spec/supabase/storage/client_spec.rb` (new: client initialization and from() tests)
  - `gems/supabase-storage/spec/supabase/storage/bucket_api_spec.rb` (new: BM-01 through BM-09 bucket management tests)
  - `gems/supabase-storage/spec/supabase/storage/file_operations_spec.rb` (new: UL-01 through UL-12, DL-01 through DL-06, FO-01 through FO-07)
  - `gems/supabase-storage/spec/supabase/storage/url_operations_spec.rb` (new: SU-01 through SU-07, PU-01 through PU-04, FL-01 through FL-06, signed upload URLs)
  - `gems/supabase-storage/spec/supabase/storage/errors_spec.rb` (new: EH-01 through EH-04, path normalization, image transform params)
  - `.chief/prds/main/prd.json` (marked US-012 as passes: true)
- **Test coverage areas:**
  - Bucket management (BM-01 through BM-09): list, get, create, update, empty, delete with success/error/network failure
  - Upload tests (UL-01 through UL-12): string/IO body, cache control, content type, upsert, metadata, path normalization, errors, update via PUT
  - Download tests (DL-01 through DL-06): basic download, binary body, transforms with render/image/authenticated path, errors, path normalization
  - Signed URL tests (SU-01 through SU-07): single/batch signed URLs, download param (boolean/filename), transforms, errors
  - Public URL tests (PU-01 through PU-04): basic URL, download param, image transforms using render/image/public path
  - File operations (FO-01 through FO-07): move (same/different bucket), copy (same/different bucket), remove, info, exists?
  - File listing tests (FL-01 through FL-06): defaults, path prefix, limit/offset, sort, search, errors
  - Error handling (EH-01 through EH-04): error hierarchy, JSON/non-JSON error extraction, network failures, timeouts
  - Path normalization: leading/trailing slashes, consecutive slashes, empty path
  - Image transform params: width, height, resize, quality, format, render/image/public and render/image/authenticated paths
- **Learnings for future iterations:**
  - `empty_bucket` sends `JSON.generate({})` which is `"{}"` (string); stub with `body: "{}"` not `body: "{}".to_json` (which double-encodes)
  - WebMock body matching: when implementation uses `JSON.generate(body)`, stub with the exact JSON string, not `.to_json` on the expected hash (which may produce different key ordering or encoding)
  - Split storage tests across 5 files by concern: client, bucket_api, file_operations, url_operations, errors
  - `hash_including` matcher in WebMock works well for asserting partial body matches (e.g., FL-02 through FL-05)
  - Rubocop `Style/StringLiterals`: prefer double-quoted strings even for `'{}'` literal
---

## 2026-02-10 - US-013
- What was implemented: Auth Client core infrastructure with error hierarchy, storage adapter, session model, JWT decoder, lock mechanism, HTTP handler, error classifier, and Client class
- Files changed:
  - `gems/supabase-auth/lib/supabase/auth.rb` (updated: added requires for all new modules)
  - `gems/supabase-auth/lib/supabase/auth/errors.rb` (new: AuthError, AuthApiError, AuthRetryableFetchError, AuthUnknownError, AuthSessionMissingError, AuthInvalidTokenResponseError, AuthInvalidCredentialsError, AuthWeakPasswordError, AuthPKCEGrantCodeExchangeError, ErrorGuards module)
  - `gems/supabase-auth/lib/supabase/auth/memory_storage.rb` (new: MemoryStorage with get_item/set_item/remove_item)
  - `gems/supabase-auth/lib/supabase/auth/session.rb` (new: Session model with expires_at computation, to_h, expired?)
  - `gems/supabase-auth/lib/supabase/auth/jwt.rb` (new: JWT module with decode and base64url_decode)
  - `gems/supabase-auth/lib/supabase/auth/lock.rb` (new: Lock class with mutex-based with_lock and configurable timeout)
  - `gems/supabase-auth/lib/supabase/auth/error_classifier.rb` (new: ErrorClassifier module for HTTP response classification)
  - `gems/supabase-auth/lib/supabase/auth/http_handler.rb` (new: HttpHandler module with request, build_connection, default_headers)
  - `gems/supabase-auth/lib/supabase/auth/client.rb` (new: Client class with constructor, get_session, get_user, session management)
  - `.chief/prds/main/prd.json` (marked US-013 as passes: true)
- **Learnings for future iterations:**
  - Auth Client uses `**options` in constructor to keep under ParameterLists limit (same pattern as Functions/PostgREST)
  - `Naming/AccessorMethodName` cop flags `get_*` methods; use `rubocop:disable` inline for API-convention names like `get_session`
  - `Naming/BlockForwarding` cop: use `&` anonymous forwarding (`def with_lock(&)`) instead of named `&block` when just yielding
  - `Style/Next` cop: prefer `next if condition` over `unless condition` inside loops for skip-iteration logic
  - `Lint/AmbiguousOperatorPrecedence`: wrap mixed `+` and `*` expressions with parentheses (e.g., base64 padding calc)
  - `Style/MutableConstant`: freeze interpolated string constants (`"supabase-rb/#{VERSION}".freeze`)
  - ErrorClassifier extracts error codes from `error_code`, `code` keys; messages from `msg`, `message`, `error_description`, `error` keys
  - Auth error classification: 502/503/504 -> AuthRetryableFetchError, 4xx+JSON -> AuthApiError, 4xx+non-JSON -> AuthUnknownError, Faraday::Error -> AuthRetryableFetchError(status: 0)
  - weak_password code produces AuthWeakPasswordError with `reasons` array from `weak_password.reasons`
  - Session model computes `expires_at` from `expires_in` if not explicitly provided
  - Lock uses `Mutex#try_lock` + sleep loop instead of blocking `synchronize` to support configurable timeout
---

## 2026-02-10 - US-014
- What was implemented: Auth Client sign-up and sign-in methods (password, OAuth, OTP, ID token, SSO, anonymous) with PKCE support and OTP verification/code exchange
- Files changed:
  - `gems/supabase-auth/lib/supabase/auth.rb` (updated: added require for pkce module)
  - `gems/supabase-auth/lib/supabase/auth/client.rb` (updated: added requires for sign_up_methods, sign_in_methods, verify_methods; includes modules)
  - `gems/supabase-auth/lib/supabase/auth/pkce.rb` (new: PKCE module with generate_code_verifier, generate_code_challenge, challenge_method)
  - `gems/supabase-auth/lib/supabase/auth/sign_up_methods.rb` (new: SignUpMethods module with sign_up, sign_in_anonymously, helper methods)
  - `gems/supabase-auth/lib/supabase/auth/sign_in_methods.rb` (new: SignInMethods module with sign_in_with_password, sign_in_with_oauth, sign_in_with_otp, sign_in_with_id_token, sign_in_with_sso)
  - `gems/supabase-auth/lib/supabase/auth/verify_methods.rb` (new: VerifyMethods module with verify_otp, exchange_code_for_session)
  - `.chief/prds/main/prd.json` (marked US-014 as passes: true)
- **Implementation details:**
  - SignUpMethods: sign_up validates email/phone presence, includes PKCE params when flow_type is :pkce, handles session vs confirmation responses
  - SignInMethods: sign_in_with_password POST to /token?grant_type=password; sign_in_with_oauth builds authorize URL (no HTTP); sign_in_with_otp POST to /otp with PKCE; sign_in_with_id_token POST to /token?grant_type=id_token; sign_in_with_sso POST to /sso with PKCE
  - VerifyMethods: verify_otp POST to /verify with session handling; exchange_code_for_session retrieves/deletes stored verifier, POST to /token?grant_type=pkce, emits PASSWORD_RECOVERY or SIGNED_IN based on verifier suffix
  - PKCE: 56 random bytes -> 112-char hex verifier, SHA-256 -> base64url challenge, stored under {storage_key}-code-verifier
  - Shared helpers: handle_session_response saves session and emits SIGNED_IN; handle_sign_up_response distinguishes session vs confirmation; append_captcha adds gotrue_meta_security; append_pkce_params stores verifier and adds challenge params
- **Learnings for future iterations:**
  - Auth sign-in/sign-up methods split into 3 modules (SignUpMethods, SignInMethods, VerifyMethods) to keep under ClassLength 100 limit
  - PKCE module uses `module_function` pattern for stateless utility methods (same as ErrorClassifier)
  - `append_pkce_params` lives in SignUpMethods since it's used by both sign_up and sign_in methods (shared via include)
  - OAuth sign_in builds URL synchronously (no HTTP call); all other sign-in methods make HTTP calls
  - Code verifier with `/PASSWORD_RECOVERY` suffix triggers `:password_recovery` event instead of `:signed_in`
  - `exchange_code_for_session` strips the suffix before sending to API, but uses original verifier for event detection
---
