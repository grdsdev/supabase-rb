## Codebase Patterns
- Use `eval "$(rbenv init -)"` before running Ruby commands to ensure Ruby 3.3.0 is active (system Ruby is 2.6)
- Root Rakefile runs all gem specs via `bundle exec rake spec` with `-I gems/{name}/spec -I gems/{name}/lib` for proper load paths
- Each gem follows pattern: `gems/{name}/lib/supabase/{module}.rb` requires `{module}/version`
- VERSION constant lives at `Supabase::{Module}::VERSION` (top-level gem uses `Supabase::VERSION`)
- Gemspecs are excluded from rubocop via `**/*.gemspec` in `.rubocop.yml`
- HTTP gems depend on `faraday ~> 2.0`, WebSocket gem depends on `websocket-client-simple ~> 0.8`
- No cross-gem runtime dependencies (except top-level `supabase` gem which depends on all 5)
- All specs use webmock for HTTP stubbing
- `.rspec` files in each gem directory with `--require spec_helper`
- Rubocop ClassLength limit is 100 lines; extract modules to keep classes small
- Use `**options` keyword splat for methods with >5 params to satisfy `Metrics/ParameterLists`
- All client methods return `{ data:, error: }` result hashes (never raise by default)
- Error hierarchy pattern: BaseError < StandardError, then specific subclasses with `status:` and `context:` attrs
- Test files go in `gems/{name}/spec/supabase/{module}/` subdirectories (e.g., `client_spec.rb`)
- WebMock: do NOT chain multiple `.to_return` on same stub (they cycle sequentially); use one `stub_request(...).to_return(...)` per test
- Rubocop `Naming/VariableNumber`: use normalcase for symbol numbers (`:ap_southeast1` not `:ap_southeast_1`)
- Faraday test adapter blocks must be multiline `do...end`, not single-line, to satisfy `Style/BlockDelimiters`
- PostgREST result hash: `{ data:, error:, count:, status:, status_text: }` (extends standard `{ data:, error: }` pattern)
- PostgREST Builder uses `**options` splat in `initialize(url:, **options)` to stay under 5 param limit
- Extract ResponseHandler module from Builder to stay under ClassLength 100 lines
- `Naming/MethodParameterName` requires 3+ chars; use `function_name` not `fn`
- `Lint/DuplicateBranch`: avoid `elsif` and `else` branches with same body; merge them
- CRUD methods return FilterBuilder (not QueryBuilder); QueryBuilder is the entry point, FilterBuilder chains further
- CrudBuilder module extracted from QueryBuilder to keep classes under 100 lines; pattern: extract `{Thing}Builder` module
- `Lint/UnusedBlockArgument`: prefix unused block args with `_` (e.g., `|_url, headers|`)
- FilterBuilder#select adds `Prefer: return=representation` for mutation results
- Bulk insert: `columns` param set from union of all Hash keys in array
- Filter methods mutate `@url` in-place and return `self` for chaining; use modules (Filters, RangeFilters) to split methods
- `Naming/PredicatePrefix` cop: use `rubocop:disable` inline for API-convention `is_*` methods that aren't predicates
- Transform methods (order, limit, range, single, csv, etc.) live in Transforms module included by FilterBuilder
- `Metrics/AbcSize`/`CyclomaticComplexity`: split methods with many boolean flags into helper + collector pattern
- `maybe_single` requires FilterBuilder#execute override for post-processing (unwrap array, synthesize PGRST116 error)
- Filter patterns with `%` (like/ilike) cause URI::InvalidURIError; test via `builder.url.query` instead of `stub_request` for those
- Text search queries with spaces get URL-encoded to `%20` by URI.parse; account for encoding in assertions
- Use `%r{}` instead of `//` for regexes containing slashes (Style/RegexpLiteral cop)
- Split large test suites into multiple files by concern (client, crud, filters, transforms, errors) for manageability
- `Style/KeywordParametersOrder`: required kwargs must come before optional kwargs in method signatures
- Storage API pattern: BucketApi module extracted from Client, StorageFileApi returned by `from(bucket_id)`
- Storage API endpoints: `/bucket` (list), `/bucket/{id}` (get/update/delete), `/bucket/{id}/empty` (empty)

---

## 2026-02-10 - US-001
- What was implemented: Multi-gem monorepo scaffolding with 6 gems (supabase, supabase-auth, supabase-postgrest, supabase-realtime, supabase-storage, supabase-functions)
- Files changed:
  - Root: Gemfile, Gemfile.lock, Rakefile, .rubocop.yml, .rspec, .ruby-version, .gitignore
  - Per gem (x6): gemspec, Gemfile, .rspec, lib/{module}.rb, lib/{module}/version.rb, spec/spec_helper.rb, spec/{module}_spec.rb
- **Learnings for future iterations:**
  - System Ruby is 2.6; must use rbenv with `eval "$(rbenv init -)"` to get Ruby 3.3.0
  - Root `*.gemspec` glob only matches root-level gemspecs; use `**/*.gemspec` to exclude nested ones
  - Running rspec from root requires explicit `-I` flags for each gem's spec and lib dirs
  - Bundler resolves all 6 gemspecs from the root Gemfile via `gemspec path:` directives
---

## 2026-02-10 - US-002
- What was implemented: Functions Client core with error hierarchy, body auto-serialization, response parsing, region routing, header precedence, and all HTTP methods
- Files changed:
  - `gems/supabase-functions/lib/supabase/functions.rb` (added requires for errors, client)
  - `gems/supabase-functions/lib/supabase/functions/errors.rb` (new: FunctionsError, FunctionsFetchError, FunctionsRelayError, FunctionsHttpError)
  - `gems/supabase-functions/lib/supabase/functions/client.rb` (new: Client class with invoke, set_auth, body/response handling)
  - `gems/supabase-functions/lib/supabase/functions/response_handler.rb` (new: extracted response processing module)
  - `.chief/prds/main/prd.json` (marked US-002 as passes: true)
- **Learnings for future iterations:**
  - Rubocop ClassLength limit is 100 lines; extract modules (e.g., ResponseHandler) to keep classes under limit
  - `Naming/AccessorMethodName` cop flags `set_*` methods; use `rubocop:disable` inline when matching external API conventions (e.g., Supabase JS client's `set_auth`)
  - `invoke` uses `**options` keyword splat instead of 6 positional params to avoid `Metrics/ParameterLists` cop
  - Rescue specific exceptions (`Faraday::Error, IOError`) instead of broad `StandardError` to avoid `Lint/DuplicateBranch`
  - Response handler: `text/event-stream` returns raw Faraday response object (not body) per Supabase spec
---

## 2026-02-10 - US-003
- What was implemented: Comprehensive test suite for the Functions client (64 tests total)
- Files changed:
  - `gems/supabase-functions/spec/supabase/functions/client_spec.rb` (new: 64 tests covering all acceptance criteria)
  - `.chief/prds/main/prd.json` (marked US-003 as passes: true)
- **Test coverage areas:**
  - AU-01 through AU-05: Authentication / set_auth persistence
  - BH-01 through BH-08: Body auto-detection and serialization (String, Hash, Array, IO, StringIO, nil, nested, empty)
  - RP-01 through RP-08: Response parsing (JSON, JSON array, text/plain, octet-stream, event-stream, charset, unknown, missing)
  - EH-01 through EH-08: Error handling (HttpError, RelayError, FetchError, network, timeout, context)
  - RR-01 through RR-05: Region routing (default :any, client-level, invoke-level override, :any override, symbol conversion)
  - TC-01 through TC-05: Timeout behavior (default, per-request, expiry, custom fetch with/without timeout)
  - HP-01 through HP-03: Header precedence (invoke > client > auto-detected)
  - HM-01 through HM-05: HTTP methods (POST, GET, PUT, PATCH, DELETE)
  - Error hierarchy tests, constructor tests, invalid method test, 5 integration scenarios
- **Learnings for future iterations:**
  - WebMock `.to_return` calls are additive (cycle through responses); never chain a helper that calls `.to_return` with another `.to_return`
  - Use direct `stub_request(:method, url).to_return(...)` in each test for clarity; avoid helpers with default responses
  - Rubocop `Naming/VariableNumber` applies to symbols too: `:ap_southeast1` not `:ap_southeast_1`
  - Faraday test adapter: use multiline `do...end` blocks to satisfy `Style/BlockDelimiters` and `Style/SingleLineDoEndBlock`
---

## 2026-02-10 - US-004
- What was implemented: PostgREST Client core builder infrastructure with error hierarchy, builder base class, query builder, response handler, and client with from/schema/rpc
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (added requires for errors, builder, query_builder, client)
  - `gems/supabase-postgrest/lib/supabase/postgrest/errors.rb` (new: PostgrestError with message, details, hint, code)
  - `gems/supabase-postgrest/lib/supabase/postgrest/response_handler.rb` (new: extracted response parsing, error handling, count parsing)
  - `gems/supabase-postgrest/lib/supabase/postgrest/builder.rb` (new: base Builder class with execute, schema headers, throw_on_error, dup_with)
  - `gems/supabase-postgrest/lib/supabase/postgrest/query_builder.rb` (new: QueryBuilder < Builder scoped to table)
  - `gems/supabase-postgrest/lib/supabase/postgrest/client.rb` (new: Client with from(), schema(), rpc())
  - `.chief/prds/main/prd.json` (marked US-004 as passes: true)
- **Learnings for future iterations:**
  - Builder uses `initialize(url:, **options)` pattern to keep params under 5; QueryBuilder passes options through via `super(url:, **options)`
  - ResponseHandler module extracted from Builder to keep class under 100 lines; includes build_result, parse_error, parse_data, parse_count, handle_fetch_error
  - PostgREST result hash adds count, status, status_text beyond the standard { data:, error: } pattern
  - `Naming/MethodParameterName` cop requires 3+ character param names; renamed `fn` to `function_name`
  - `Lint/DuplicateBranch`: text/csv and else both returned response.body, merged into single else branch
  - Builder#dup_with is the immutability mechanism: dups URL and headers to ensure independence
  - Schema headers: Accept-Profile for GET/HEAD, Content-Profile for POST/PATCH/DELETE
---

## 2026-02-10 - US-005
- What was implemented: PostgREST CRUD operations (select, insert, update, upsert, delete) with FilterBuilder for mutation chaining
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest/crud_builder.rb` (new: CrudBuilder module with select, insert, update, upsert, delete methods)
  - `gems/supabase-postgrest/lib/supabase/postgrest/filter_builder.rb` (new: FilterBuilder < Builder with .select for return=representation)
  - `gems/supabase-postgrest/lib/supabase/postgrest/query_builder.rb` (updated: includes CrudBuilder module)
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (updated: added requires for filter_builder and crud_builder)
  - `.chief/prds/main/prd.json` (marked US-005 as passes: true)
- **Implementation details:**
  - QueryBuilder includes CrudBuilder module with select, insert, update, upsert, delete
  - Each CRUD method returns a FilterBuilder (for chaining filters/transforms in US-006/US-007)
  - FilterBuilder#select adds `Prefer: return=representation` and `?select=` for mutation results
  - Bulk insert (Array of Hashes) auto-sets `columns` query param from union of all Hash keys
  - Upsert sets `Prefer: resolution=merge-duplicates` (default) or `resolution=ignore-duplicates`
  - `default_to_null: false` adds `Prefer: missing=default`
  - `on_conflict` sets the `on_conflict` query param for upserts
  - `count` option adds `Prefer: count={algorithm}` header for all operations
  - `head: true` on select uses HEAD method
- **Learnings for future iterations:**
  - Extract CRUD methods into CrudBuilder module to keep QueryBuilder small (rubocop ClassLength)
  - FilterBuilder extends Builder so it inherits execute/schema headers/throw_on_error
  - Use `_url` prefix for unused block args to satisfy `Lint/UnusedBlockArgument`
  - `dup_with` pattern from Builder reused in FilterBuilder for immutable .select chaining
---

## 2026-02-10 - US-006
- What was implemented: PostgREST Filter Builder with all comparison, pattern, regex, collection, range, text search, and compound filter methods
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest/filters.rb` (new: Filters module with eq, neq, gt, gte, lt, lte, is, is_distinct, like, ilike, like_all_of, like_any_of, ilike_all_of, ilike_any_of, match, imatch, in, contains, contained_by, overlaps)
  - `gems/supabase-postgrest/lib/supabase/postgrest/range_filters.rb` (new: RangeFilters module with range_gt, range_gte, range_lt, range_lte, range_adjacent, text_search, match_filter, not, or, filter)
  - `gems/supabase-postgrest/lib/supabase/postgrest/filter_builder.rb` (updated: includes Filters and RangeFilters modules, added private helpers append_filter, quote_filter_value, format_containment)
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (updated: added requires for filters and range_filters)
  - `.chief/prds/main/prd.json` (marked US-006 as passes: true)
- **Learnings for future iterations:**
  - `Naming/PredicatePrefix` cop flags `is_*` methods as predicates; use `rubocop:disable` inline for PostgREST API-convention method names like `is_distinct`
  - Filter methods mutate `@url` in-place and return `self` for chaining (not immutable like `select`)
  - Extract filter methods into multiple modules (Filters, RangeFilters) to stay under ClassLength 100 limit
  - `in` filter: values with reserved chars (comma, parens, quotes) must be quoted with escaped double quotes
  - `contains`/`contained_by`/`overlaps`: Array becomes `{a,b}`, Hash becomes JSON-serialized string
  - `or` filter uses `key=(filters)` format; with `referenced_table`, key becomes `table.or`
  - `match_filter` applies multiple `eq` filters from a Hash
  - `text_search` operator mapping: nil->fts, :plain->plfts, :phrase->phfts, :websearch->wfts; config appended as `op(config)`
---

## 2026-02-10 - US-007
- What was implemented: PostgREST Transform Builder with order, limit, range, single, maybe_single, csv, geojson, explain, rollback, and max_affected methods
- Files changed:
  - `gems/supabase-postgrest/lib/supabase/postgrest/transforms.rb` (new: Transforms module with all transform methods)
  - `gems/supabase-postgrest/lib/supabase/postgrest/filter_builder.rb` (updated: includes Transforms module, added execute override for maybe_single, added handle_maybe_single)
  - `gems/supabase-postgrest/lib/supabase/postgrest.rb` (updated: added require for transforms)
  - `.chief/prds/main/prd.json` (marked US-007 as passes: true)
- **Implementation details:**
  - Transforms module extracted to keep FilterBuilder under 100 lines (same pattern as Filters/RangeFilters)
  - `order` supports multiple calls by appending to existing order param (comma-separated)
  - `range(from, to)` converts to offset + limit params (0-based inclusive: limit = to - from + 1)
  - `single` sets Accept: application/vnd.pgrst.object+json; PostgREST errors on != 1 row
  - `maybe_single` sets same Accept header + @maybe_single flag; execute override unwraps arrays and synthesizes PGRST116 error on >1 row
  - `explain` builds Accept header with `for="explain"` prefix and pipe-separated options
  - `rollback` and `max_affected` append to Prefer header
  - Transform methods mutate `@headers`/`@url` in-place and return `self` for chaining (same as filter methods)
- **Learnings for future iterations:**
  - `Metrics/AbcSize` and `CyclomaticComplexity`: split methods with many boolean flags into helper + collector (e.g., `build_explain_header` + `collect_explain_parts`)
  - `Lint/DuplicateBranch`: remove redundant if/else with same body (e.g., maybe_single had identical branches for GET vs non-GET)
  - `order` appending: use regex gsub on existing query string to append comma-separated values to existing `order=` param
  - `maybe_single` needs FilterBuilder#execute override (not Builder) since it's post-processing logic specific to the result
---

## 2026-02-10 - US-008
- What was implemented: Comprehensive test suite for the PostgREST client (127 tests total across 4 test files)
- Files changed:
  - `gems/supabase-postgrest/spec/supabase/postgrest/client_spec.rb` (new: CI-01 through CI-06, from/schema/RPC tests, SC-01 through SC-04, RP-01 through RP-07)
  - `gems/supabase-postgrest/spec/supabase/postgrest/crud_spec.rb` (new: SE-01 through SE-07, IN-01 through IN-05, UP-01 through UP-02, US-01 through US-03, DE-01 through DE-03)
  - `gems/supabase-postgrest/spec/supabase/postgrest/filters_spec.rb` (new: FI-01 through FI-25, range filters, text search, compound filters)
  - `gems/supabase-postgrest/spec/supabase/postgrest/transforms_spec.rb` (new: TR-01 through TR-17, explain, rollback, max_affected)
  - `gems/supabase-postgrest/spec/supabase/postgrest/errors_spec.rb` (new: EH-01 through EH-08, BI-01 through BI-03, response parsing, custom fetch, error hierarchy)
  - `.chief/prds/main/prd.json` (marked US-008 as passes: true)
- **Test coverage areas:**
  - Client initialization (CI-01 through CI-06)
  - SELECT operations (SE-01 through SE-07)
  - INSERT operations (IN-01 through IN-05)
  - UPDATE operations (UP-01 through UP-02)
  - UPSERT operations (US-01 through US-03)
  - DELETE operations (DE-01 through DE-03)
  - All filters (FI-01 through FI-25): eq, neq, gt, gte, lt, lte, is, is_distinct, like, ilike, like_all_of, like_any_of, ilike_all_of, ilike_any_of, match, imatch, in, contains, contained_by, overlaps, chaining
  - Range filters: range_gt, range_gte, range_lt, range_lte, range_adjacent
  - Text search: fts, plfts, phfts, wfts with config
  - Compound filters: match_filter, not, or, filter
  - All transforms (TR-01 through TR-17): order, limit, range, single, maybe_single, csv, geojson, explain, rollback, max_affected
  - RPC (RP-01 through RP-07): POST/GET/HEAD, count, schema
  - Error handling (EH-01 through EH-08): JSON errors, non-JSON errors, network errors, timeout, throw_on_error
  - Schema switching (SC-01 through SC-04): Accept-Profile, Content-Profile
  - Builder immutability (BI-01 through BI-03): from() independence, throw_on_error copies, select copies
  - Response parsing: JSON, vnd.pgrst, CSV, Content-Range count
  - URL construction validation across all test categories
- **Learnings for future iterations:**
  - Split tests into multiple files (client, crud, filters, transforms, errors) to keep files manageable
  - Patterns with `%` chars in like/ilike filter tests cause URI::InvalidURIError when used via `append_query_param` with URI.parse; test query string assertions instead of HTTP stubs for those patterns
  - Text search queries with spaces get URL-encoded by URI.parse; match against `%20` in query string assertions
  - Use `%r{}` instead of `//` for regexes with slashes (Style/RegexpLiteral cop)
  - Unused variable assignments in tests trigger `Lint/UselessAssignment`; omit the assignment if the return value isn't checked
---

## 2026-02-10 - US-009
- What was implemented: Storage Client core with error hierarchy, bucket management API, and StorageFileApi stub
- Files changed:
  - `gems/supabase-storage/lib/supabase/storage.rb` (updated: added requires for errors and client)
  - `gems/supabase-storage/lib/supabase/storage/errors.rb` (new: StorageError, StorageApiError, StorageUnknownError)
  - `gems/supabase-storage/lib/supabase/storage/client.rb` (new: Client with from(), bucket management delegation, HTTP helpers)
  - `gems/supabase-storage/lib/supabase/storage/bucket_api.rb` (new: BucketApi module with list_buckets, get_bucket, create_bucket, update_bucket, empty_bucket, delete_bucket)
  - `gems/supabase-storage/lib/supabase/storage/storage_file_api.rb` (new: StorageFileApi stub class for file operations)
  - `.chief/prds/main/prd.json` (marked US-009 as passes: true)
- **Implementation details:**
  - Error hierarchy follows same pattern as Functions: base StorageError < StandardError with `context:`, subclasses add `status:`
  - StorageApiError for HTTP errors (non-2xx), StorageUnknownError for network/Faraday failures
  - BucketApi module extracted from Client to keep classes under 100 lines (ClassLength cop)
  - Client delegates bucket methods via `include BucketApi`; `from(bucket_id)` returns a StorageFileApi scoped to the bucket
  - All bucket methods return `{ data:, error: }` pattern; rescue Faraday::Error for network failures
  - JSON responses auto-parsed; error messages extracted from JSON `message` or `error` keys
  - StorageFileApi is a stub with `initialize(url:, bucket_id:, headers: {}, fetch: nil)` ready for US-010/US-011
- **Learnings for future iterations:**
  - `Style/KeywordParametersOrder`: required kwargs must come before optional kwargs (e.g., `bucket_id:` before `headers: {}`)
  - Storage API endpoints: `/bucket` for list, `/bucket/{id}` for get/update/delete, `/bucket/{id}/empty` for empty
  - `create_bucket` sends both `id` and `name` fields (both set to the bucket_id)
  - `update_bucket` requires `public:` field in the body
  - Running specs from root requires `bundle exec rake supabase_storage:spec` (not direct `rspec` which lacks `-I` flags)
---
